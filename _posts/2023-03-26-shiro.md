---
tags: [shiro]
---

[å®˜ç½‘](https://shiro.apache.org)

[æºç åœ°å€](https://github.com/apache/shiro)

## 1 ç®€ä»‹

Apache Shiro æ˜¯ä¸€ä¸ªå¼€æºçš„å®‰å…¨ç®¡ç†æ¡†æ¶ï¼Œæä¾›èº«ä»½è®¤è¯ã€æˆæƒã€å¯†ç å­¦å’Œä¼šè¯ç®¡ç†ã€‚

Shiro æ¡†æ¶ç›´è§‚ã€æ˜“ç”¨ï¼ŒåŒæ—¶æä¾›å¥å£®çš„å®‰å…¨æ€§ã€‚

ç›¸å¯¹äº Spring Security è€Œè¨€ï¼ŒShiro æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å®‰å…¨ç®¡ç†æ¡†æ¶ã€‚

### 1.1 ç”±æ¥

Shiro çš„å‰èº«æ˜¯ JSecurityï¼Œ2004å¹´ï¼ŒLes Hazlewood å’Œ Jeremy Haile åˆ›åŠäº† JSecurityã€‚å½“æ—¶æ²¡æœ‰åˆé€‚çš„é€‚ç”¨äºåº”ç”¨ç¨‹åºçº§åˆ«çš„ Java å®‰å…¨ç®¡ç†æ¡†æ¶ï¼ŒåŒæ—¶åˆå¯¹ JAAS éå¸¸å¤±æœ›ã€‚2004å¹´åˆ°2008å¹´æœŸé—´ï¼ŒJSecurity æ‰˜ç®¡åœ¨ SourceForge ä¸Šï¼Œè´¡çŒ®è€…åŒ…æ‹¬ Peter Ledbrookã€Alan Ditzel å’Œ Tim Veilã€‚2008å¹´ï¼ŒJSecurity é¡¹ç›®è´¡çŒ®ç»™äº† Apache è½¯ä»¶åŸºé‡‘ä¼šï¼ˆASFï¼‰ï¼Œå¹¶è¢«æ¥çº³æˆä¸º Apache Incubator é¡¹ç›®ï¼Œç”±å¯¼å¸ˆç®¡ç†ï¼Œç›®æ ‡æ˜¯æˆä¸ºä¸€ä¸ªé¡¶çº§ Apache é¡¹ç›®ã€‚æœŸé—´ï¼ŒJSecurity æ›¾çŸ­æš‚æ›´åä¸º Kiï¼Œéšåå› å•†æ ‡é—®é¢˜è¢«ç¤¾åŒºæ›´åä¸ºâ€œShiroâ€ã€‚éšåé¡¹ç›®æŒç»­åœ¨ Apache Incubator ä¸­å­µåŒ–ï¼Œå¹¶å¢åŠ äº†è´¡çŒ®è€… Kalle Korhonenã€‚2010å¹´7æœˆï¼ŒShiro ç¤¾åŒºå‘å¸ƒäº† 1.0 ç‰ˆï¼Œéšåç¤¾åŒºåˆ›å»ºäº†å…¶é¡¹ç›®ç®¡ç†å§”å‘˜ä¼šï¼Œå¹¶é€‰ä¸¾ Les Hazlewood ä¸ºä¸»å¸­ã€‚2010å¹´9æœˆ22æ—¥ï¼ŒShrio æˆä¸º Apache è½¯ä»¶åŸºé‡‘ä¼šçš„é¡¶çº§é¡¹ç›®ï¼ˆTLPï¼‰ã€‚

### 1.2 åŠŸèƒ½

Apache Shiro æ˜¯ä¸€ä¸ªå¼ºå¤§è€Œåˆçµæ´»å¹¶å¼€æºçš„å®‰å…¨ç®¡ç†æ¡†æ¶ï¼Œå®ƒæç®€å¤„ç†èº«ä»½è®¤è¯ï¼Œæˆæƒï¼ŒåŠ å¯†å’Œä¼ä¸šä¼šè¯ç®¡ç†ã€‚Apache Shiro çš„é¦–è¦ç›®æ ‡æ˜¯æ˜“äºä½¿ç”¨å’Œç†è§£ã€‚

Apache Shiro å¯ä»¥åšçš„äº‹æƒ…ï¼š

1. éªŒè¯ç”¨æˆ·æ ¸å®èº«ä»½
2. å¯¹ç”¨æˆ·æ‰§è¡Œè®¿é—®æ§åˆ¶
3. åœ¨ä»»ä½•ç¯å¢ƒä¸‹ä½¿ç”¨ Session APIï¼Œå³ä½¿æ²¡æœ‰Webå®¹å™¨
4. åœ¨èº«ä»½è®¤è¯ï¼Œè®¿é—®æ§åˆ¶æœŸé—´æˆ–åœ¨ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯¹äº‹ä»¶ä½œå‡ºååº”
5. èšé›†ä¸€ä¸ªæˆ–å¤šä¸ªç”¨æˆ·å®‰å…¨æ•°æ®çš„æ•°æ®æºï¼Œå¹¶ä½œä¸ºä¸€ä¸ªå•ä¸€çš„å¤åˆç”¨æˆ·â€œè§†å›¾â€
6. å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰
7. ä¸ºç™»å½•çš„ç”¨æˆ·å¯ç”¨"Remember Me"æœåŠ¡

Apache Shiro æ˜¯ä¸€ä¸ªæ‹¥æœ‰å¾ˆå¤šåŠŸèƒ½çš„ç»¼åˆæ€§ç¨‹åºå®‰å…¨æ¡†æ¶ã€‚ä¸‹å›¾å±•ç¤ºäº† Shiro çš„é‡ç‚¹ï¼š

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303261810934.png)

Shiro å››å¤§åŸºçŸ³â€”â€”èº«ä»½è®¤è¯ï¼Œæˆæƒï¼Œä¼šè¯ç®¡ç†å’ŒåŠ å¯†ã€‚

1. Authenticationï¼šç®€ç§°ä¸ºâ€œç™»å½•â€ï¼Œè¿™æ˜¯ä¸€ä¸ªè¯æ˜ç”¨æˆ·æ˜¯è°çš„è¡Œä¸ºã€‚
2. Authorizationï¼šè®¿é—®æ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯å†³å®šâ€œè°â€å»è®¿é—®â€œä»€ä¹ˆâ€ã€‚
3. Session Managementï¼šç®¡ç†ç”¨æˆ·ç‰¹å®šçš„ä¼šè¯ï¼Œå³ä½¿åœ¨é Web åº”ç”¨ç¨‹åºã€‚
4. Cryptographyï¼šé€šè¿‡ä½¿ç”¨åŠ å¯†ç®—æ³•ä¿æŒæ•°æ®å®‰å…¨çš„åŒæ—¶åˆæ˜“äºä½¿ç”¨ã€‚

é™¤æ­¤ä¹‹å¤–ï¼ŒShiro ä¹Ÿæä¾›äº†é¢å¤–çš„åŠŸèƒ½æ¥è§£å†³åœ¨ä¸åŒç¯å¢ƒä¸‹æ‰€é¢ä¸´çš„å®‰å…¨é—®é¢˜ï¼Œå°¤å…¶æ˜¯ä»¥ä¸‹è¿™äº›ï¼š

1. Web Supportï¼šShiro Web æ”¯æŒçš„ API èƒ½å¤Ÿè½»æ¾åœ°å¸®åŠ©ä¿æŠ¤ Web åº”ç”¨ç¨‹åºã€‚
2. Cachingï¼šç¼“å­˜æ˜¯ Apache Shiro ä¸­çš„ç¬¬ä¸€å±‚å…¬æ°‘ï¼Œæ¥ç¡®ä¿å®‰å…¨æ“ä½œå¿«é€Ÿè€Œåˆé«˜æ•ˆã€‚
3. Concurrencyï¼šApache Shiro åˆ©ç”¨å®ƒçš„å¹¶å‘ç‰¹æ€§æ¥æ”¯æŒå¤šçº¿ç¨‹åº”ç”¨ç¨‹åºã€‚
4. Testingï¼šæµ‹è¯•æ”¯æŒæ¥å¸®åŠ©ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ã€‚
5. "Run As"ï¼šä¸€ä¸ªå…è®¸ç”¨æˆ·å‡è®¾æˆä¸ºå¦ä¸€ä¸ªç”¨æˆ·èº«ä»½çš„åŠŸèƒ½ï¼Œåœ¨ç®¡ç†è„šæœ¬æ—¶å¯ä»¥èµ·åˆ°å¾ˆå¤§çš„ä½œç”¨ã€‚
6. "Remember Me"ï¼šåœ¨ä¼šè¯ä¸­è®°ä½ç”¨æˆ·çš„èº«ä»½ï¼Œè¿™æ ·ç”¨æˆ·åªéœ€è¦åœ¨å¼ºåˆ¶ç™»å½•æ—¶å€™ç™»å½•ã€‚

## 2 åˆæ­¥äº†è§£

### 2.1ä¸‹è½½

[shiro-root-1.7.1](https://github.com/apache/shiro/archive/refs/tags/shiro-root-1.7.1.zip)

### 2.2 å¿«é€Ÿå¼€å§‹

æºç ä¸­æœ‰ä¸€ä¸ªå¿«é€Ÿå¼€å§‹çš„ç®€å•æ¡ˆä¾‹ï¼šğŸŒ°samples - quickstartğŸŒ°ï¼›è¿™æ˜¯ä¸€ä¸ª JavaSE é¡¹ç›®ï¼Œè¿™ä¸ªç®€å•æ¡ˆä¾‹å¯ä»¥è®©æˆ‘ä»¬åˆæ­¥äº†è§£ Shiro çš„ç™»å½•ï¼ˆAuthenticationï¼‰å’Œæˆæƒï¼ˆAuthorizationï¼‰ã€‚

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303261808579.png)

shiro.ini

```ini
# é…ç½®ç”¨æˆ·
[users]
# user 'root' with password 'secret' and the 'admin' role
# ç”¨æˆ·åï¼šrootï¼Œå¯†ç ï¼šsecretï¼Œè§’è‰²ï¼šadmin
root = secret, admin
# user 'guest' with the password 'guest' and the 'guest' role
guest = guest, guest
# user 'presidentskroob' with password '12345' ("That's the same combination on
# my luggage!!!" ;)), and role 'president'
presidentskroob = 12345, president
# user 'darkhelmet' with password 'ludicrousspeed' and roles 'darklord' and 'schwartz'
# å¤šä¸ªè§’è‰²
darkhelmet = ludicrousspeed, darklord, schwartz
# user 'lonestarr' with password 'vespa' and roles 'goodguy' and 'schwartz'
lonestarr = vespa, goodguy, schwartz

# é…ç½®è§’è‰²
[roles]
# 'admin' role has all permissions, indicated by the wildcard '*'
admin = *
# The 'schwartz' role can do anything (*) with any lightsaber:
schwartz = lightsaber:*
# The 'goodguy' role is allowed to 'drive' (action) the winnebago (type) with
# license plate 'eagle5' (instance specific id)
goodguy = winnebago:drive:eagle5
```

Quickstart.java

```java
import org.apache.shiro.SecurityUtils;
import org.apache.shiro.authc.*;
import org.apache.shiro.config.IniSecurityManagerFactory;
import org.apache.shiro.mgt.SecurityManager;
import org.apache.shiro.session.Session;
import org.apache.shiro.subject.Subject;
import org.apache.shiro.util.Factory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Simple Quickstart application showing how to use Shiro's API.
 *
 * @since 0.9 RC2
 */
public class Quickstart {

    private static final transient Logger log = LoggerFactory.getLogger(Quickstart.class);


    public static void main(String[] args) {

        // * ä½¿ç”¨ shiro.ini æ–‡ä»¶æ¥åˆ›å»ºä¸€ä¸ª SecurityManager å¯¹è±¡
        Factory<SecurityManager> factory = new IniSecurityManagerFactory("classpath:shiro.ini");
        SecurityManager securityManager = factory.getInstance();
        
        // * å°† SecurityManager è®¾ç½®ç»™ SecurityUtilsï¼Œä»¥ä¾¿å°†æ¥è·å– Subject
        SecurityUtils.setSecurityManager(securityManager);
        
        // * è·å–å½“å‰çš„è®¿é—®å¯¹è±¡
        // * è¿™é‡Œæ‹¿åˆ°çš„ Subject å¯èƒ½æ˜¯å·²ç»ç™»å½•çš„ç”¨æˆ·å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªåŒ¿åçš„ç”¨æˆ·å¯¹è±¡
        Subject currentUser = SecurityUtils.getSubject();
        
        // * è·å– Session å¯¹è±¡
        Session session = currentUser.getSession();
        // * å…³äº Session çš„æ“ä½œ
        session.setAttribute("someKey", "aValue");
        String value = (String) session.getAttribute("someKey");
        if (value.equals("aValue")) {
            log.info("Retrieved the correct value! [" + value + "]");
        }
        
        // * åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•
        if (!currentUser.isAuthenticated()) {
            // * æ„å»º UsernamePasswordToken å‡†å¤‡ç™»é™†
            UsernamePasswordToken token = new UsernamePasswordToken("lonestarr", "vespa");
            // * è®¾ç½®è®°ä½æˆ‘
            token.setRememberMe(true);
            try {
                // * æ‰§è¡Œç™»é™†æ“ä½œ
                currentUser.login(token);
            } catch (UnknownAccountException uae) {
                // * ç”¨æˆ·åé”™è¯¯ï¼ŒæŠ›å‡º UnknownAccountException å¼‚å¸¸
                log.info("There is no user with username of " + token.getPrincipal());
            } catch (IncorrectCredentialsException ice) {
                // * å¯†ç é”™è¯¯ï¼ŒæŠ›å‡º IncorrectCredentialsException å¼‚å¸¸
                log.info("Password for account " + token.getPrincipal() + " was incorrect!");
            } catch (LockedAccountException lae) {
                // * è´¦æˆ·è¢«é”å®šï¼ŒæŠ›å‡º LockedAccountException å¼‚å¸¸
                log.info("The account for username " + token.getPrincipal() + " is locked.  " +
                        "Please contact your administrator to unlock it.");
            }
            // ... catch more exceptions here (maybe custom ones specific to your application?
            catch (AuthenticationException ae) {
                //unexpected condition?  error?
            }
        }
        
        // * æ‰“å°å½“å‰ç™»å½•çš„ç”¨æˆ·å
        log.info("User [" + currentUser.getPrincipal() + "] logged in successfully.");

        
        // * æµ‹è¯•å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡ schwartz è§’è‰²
        if (currentUser.hasRole("schwartz")) {
            log.info("May the Schwartz be with you!");
        } else {
            log.info("Hello, mere mortal.");
        }
        
        // * æµ‹è¯•å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡ lightsaber:wield æƒé™
        if (currentUser.isPermitted("lightsaber:wield")) {
            log.info("You may use a lightsaber ring.  Use it wisely.");
        } else {
            log.info("Sorry, lightsaber rings are for schwartz masters only.");
        }
        
        // * æµ‹è¯•å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡ winnebago:drive:eagle5 æƒé™
        if (currentUser.isPermitted("winnebago:drive:eagle5")) {
            log.info("You are permitted to 'drive' the winnebago with license plate (id) 'eagle5'.  " +
                    "Here are the keys - have fun!");
        } else {
            log.info("Sorry, you aren't allowed to drive the 'eagle5' winnebago!");
        }
        
        // * æ³¨é”€ç™»å½•
        currentUser.logout();

        System.exit(0);
    }
}
```

## 3 SSM æ•´åˆ Shiro

### 3.1 Spring + SpringMVC

1. åˆ›å»ºé¡¹ç›®

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202302201328026.png)

2. å¼•å…¥ä¾èµ–å¹¶é…ç½®æ‰“åŒ…æ–¹å¼

   ```xml
   <packaging>war</packaging>

   <dependencies>
       <dependency>
           <groupId>org.springframework</groupId>
           <artifactId>spring-webmvc</artifactId>
           <version>5.3.25</version>
       </dependency>
   </dependencies>
   ```

3. Spring é…ç½®æ–‡ä»¶ applicationContext.xml
   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <beans xmlns="http://www.springframework.org/schema/beans"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xmlns:context="http://www.springframework.org/schema/context"
          xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd">
   
       <context:component-scan base-package="top.yueyazhui.learn_shiro" use-default-filters="true">
           <context:exclude-filter type="annotation" expression="org.springframework.stereotype.Controller"/>
       </context:component-scan>
   </beans>
   ```

4. SpringMVC é…ç½®æ–‡ä»¶ spring-servlet.xml

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <beans xmlns="http://www.springframework.org/schema/beans"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns:context="http://www.springframework.org/schema/context"
              xmlns:mvc="http://www.springframework.org/schema/mvc"
              xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc https://www.springframework.org/schema/mvc/spring-mvc.xsd">

       <context:component-scan base-package="top.yueyazhui.learn_shiro" use-default-filters="false">
           <context:include-filter type="annotation" expression="org.springframework.stereotype.Controller"/>
       </context:component-scan>

       <!-- å¯ç”¨æ³¨è§£é©±åŠ¨çš„å¤„ç†å™¨æ˜ å°„ã€é€‚é…å™¨å’Œè§†å›¾è§£æå™¨ -->
       <mvc:annotation-driven/>
   </beans>

   ```

5. åˆ›å»º webapp æ–‡ä»¶å¤¹

   ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202302201328850.png)

6. é…ç½® web.xml æ–‡ä»¶

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
            version="4.0">

       <context-param>
           <param-name>contextConfigLocation</param-name>
           <param-value>classpath:applicationContext.xml</param-value>
       </context-param>
       
       <listener>
           <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
       </listener>
       
       <servlet>
           <servlet-name>springmvc</servlet-name>
           <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
           <init-param>
               <param-name>contextConfigLocation</param-name>
               <param-value>classpath:spring-servlet.xml</param-value>
           </init-param>
       </servlet>
       <servlet-mapping>
           <servlet-name>springmvc</servlet-name>
           <url-pattern>/</url-pattern>
       </servlet-mapping>
   </web-app>
   ```

7. HelloController

   ```java
   /**
    * @Author yueyazhui
    * @Date 2023/2/18
    */
   @RestController
   public class HelloController {

       @GetMapping("")
       public String hello() {
           return "Hello Shiro";
       }
   }
   ```

8. é…ç½® tomcat

   ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202302201329978.png)

   ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202302201329407.png)

9. å¯åŠ¨

   ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202302201329312.png)

10. é¡¹ç›®ç›®å½•

  ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202302201330464.png)

### 3.2 MyBatis

1. æ·»åŠ ä¾èµ–

   ```xml
   <dependency>
       <groupId>org.mybatis</groupId>
       <artifactId>mybatis</artifactId>
       <version>3.5.11</version>
   </dependency>
   <dependency>
       <groupId>org.mybatis</groupId>
       <artifactId>mybatis-spring</artifactId>
       <version>2.0.7</version>
   </dependency>

   <dependency>
       <groupId>mysql</groupId>
       <artifactId>mysql-connector-java</artifactId>
       <version>8.0.30</version>
   </dependency>
   <dependency>
       <groupId>org.springframework</groupId>
       <artifactId>spring-jdbc</artifactId>
       <version>5.3.25</version>
   </dependency>
   <dependency>
       <groupId>com.alibaba</groupId>
       <artifactId>druid</artifactId>
       <version>1.2.8</version>
   </dependency>
   ```

2. åˆ›å»ºæ•°æ®åº“

   ```sql
   /*
    Navicat Premium Data Transfer

    Source Server         : localhost
    Source Server Type    : MySQL
    Source Server Version : 80030
    Source Host           : localhost:3306
    Source Schema         : learn_shiro

    Target Server Type    : MySQL
    Target Server Version : 80030
    File Encoding         : 65001

    Date: 19/02/2023 18:50:50
   */

   SET NAMES utf8mb4;
   SET FOREIGN_KEY_CHECKS = 0;

   -- ----------------------------
   -- Table structure for sys_user
   -- ----------------------------
   DROP TABLE IF EXISTS `sys_user`;
   CREATE TABLE `sys_user`  (
     `id` int NOT NULL AUTO_INCREMENT COMMENT 'ID',
     `username` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT 'ç”¨æˆ·å',
     `password` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT 'å¯†ç ',
     PRIMARY KEY (`id`) USING BTREE
   ) ENGINE = InnoDB AUTO_INCREMENT = 2 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci COMMENT = 'ç”¨æˆ·' ROW_FORMAT = Dynamic;

   -- ----------------------------
   -- Records of sys_user
   -- ----------------------------
   INSERT INTO `sys_user` VALUES (1, 'yueyazhui', '123');

   SET FOREIGN_KEY_CHECKS = 1;
   ```

3. db.properties

   ```properties
   db.username=root
   db.password=123456
   db.driver=com.mysql.cj.jdbc.Driver
   db.url=jdbc:mysql:///learn_shiro?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=Asia/Shanghai&allowMultiQueries=true
   ```

4. applicationContext.xml

   ```xml
   <context:property-placeholder location="classpath:db.properties"/>
   
   <bean class="com.alibaba.druid.pool.DruidDataSource" id="dataSource">
       <property name="driverClassName" value="${db.driver}"/>
       <property name="url" value="${db.url}"/>
       <property name="username" value="${db.username}"/>
       <property name="password" value="${db.password}"/>
   </bean>
   
   <bean class="org.mybatis.spring.SqlSessionFactoryBean" id="sqlSessionFactoryBean">
       <property name="dataSource" ref="dataSource"/>
       <property name="mapperLocations">
           <list>
               <value>classpath*:top/yueyazhui/learn_shiro/mapper/xml/*.xml</value>
           </list>
       </property>
   </bean>
   
   <bean class="org.mybatis.spring.mapper.MapperScannerConfigurer" id="mapperScannerConfigurer">
       <property name="sqlSessionFactoryBeanName" value="sqlSessionFactoryBean"/>
       <property name="basePackage" value="top.yueyazhui.learn_shiro.mapper"/>
   </bean>
   ```

### 3.3 Shiro

1. æ·»åŠ ä¾èµ–

   ```xml
   <dependency>
       <groupId>org.apache.shiro</groupId>
       <artifactId>shiro-web</artifactId>
       <version>1.7.1</version>
   </dependency>
   <dependency>
       <groupId>org.apache.shiro</groupId>
       <artifactId>shiro-spring</artifactId>
       <version>1.7.1</version>
   </dependency>
   ```

2. web.xml ä¸­é…ç½®ä»£ç†è¿‡æ»¤å™¨

   ä¸ç®¡æ˜¯ SpringSecurity è¿˜æ˜¯ Shiroï¼Œéƒ½æ˜¯é€šè¿‡ä¸€å †è¿‡æ»¤å™¨æ¥å®ç°çš„ï¼Œé‚£å¦‚ä½•æŠŠ Shiro é‡Œçš„è¿‡æ»¤å™¨é…ç½®è¿›æ¥ï¼›

   DelegatingFilterProxy ä»£ç†è¿‡æ»¤å™¨ï¼Œæºç å‰–æï¼šè¿™ä¸ªè¿‡æ»¤å™¨å°±æ˜¯ä» Spring å®¹å™¨ä¸­é€šè¿‡ FilterName æ¥è·å–çš„ï¼›

   ```xml
   <filter>
       <filter-name>shiroFilter</filter-name>
       <filter-class>org.springframework.web.filter.DelegatingFilterProxy</filter-class>
   </filter>
   <filter-mapping>
       <filter-name>shiroFilter</filter-name>
       <url-pattern>/*</url-pattern>
   </filter-mapping>
   ```

### 3.4 è‡ªå®šä¹‰ Realm

1. User.java

   ```java
   /**
    * @Author yueyazhui
    * @Date 2023/2/18
    */
   @Data
   public class User {

       private Integer id;
       private String username;
       private String password;
   }
   ```

2. MyRealm01.java

   ```java
   /**
    * @Author yueyazhui
    * @Date 2023/2/18
    *
    * ç»§æ‰¿ AuthenticatingRealm å¯ä»¥å®ç°è®¤è¯åŠŸèƒ½
    */
   public class MyRealm01 extends AuthenticatingRealm {

       private UserService userService;

       public MyRealm01(UserService userService) {
           this.userService = userService;
       }

       /**
        * æ ¸å¿ƒæ–¹æ³•ï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        *
        * @param authenticationToken åŒ…å«ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ç­‰ä¿¡æ¯
        * @return ä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯
        * @throws AuthenticationException
        */
       @Override
       protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
           UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) authenticationToken;
           // è·å–ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥çš„ç”¨æˆ·å
           String username = usernamePasswordToken.getUsername();
           User user = userService.getUserByUsername(username);
           if (ObjectUtil.isNull(user)) {
               throw new UnknownAccountException("ç”¨æˆ·åè¾“å…¥é”™è¯¯");
           }
           // è¿”å›æŸ¥è¯¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯
           return new SimpleAuthenticationInfo(user.getUsername(), user.getPassword(), getName());
       }
   }
   ```

3. UserServiceImpl.java

   ```java
   /**
    * @Author yueyazhui
    * @Date 2023/2/18
    */
   @Service
   public class UserServiceImpl implements UserService {

       @Autowired
       UserMapper userMapper;

       @Override
       public User getUserByUsername(String username) {
           return userMapper.getUserByUsername(username);
       }
   }
   ```

4. UserMapper.xml

   ```xml
   <?xml version="1.0" encoding="UTF-8" ?>
   <!DOCTYPE mapper
           PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
           "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   <mapper namespace="top.yueyazhui.learn_shiro.mapper.UserMapper">
   
       <select id="getUserByUsername" resultType="top.yueyazhui.learn_shiro.entity.User">
           SELECT id, username, password FROM sys_user WHERE username = #{username};
       </select>
   </mapper>
   ```

### 3.5 SSM æ•´åˆ Shiro

1. åœ¨ Spring é…ç½®æ–‡ä»¶ï¼ˆapplicationContext.xmlï¼‰ä¸­é…ç½® Shiro

   ```xml
   <bean id="myRealm" class="top.yueyazhui.learn_shiro.realm.MyRealm01"/>

   <bean id="securityManager" class="org.apache.shiro.web.mgt.DefaultWebSecurityManager">
       <property name="realm" ref="myRealm"/>
   </bean>

   <bean id="shiroFilter" class="org.apache.shiro.spring.web.ShiroFilterFactoryBean">
       <property name="securityManager" ref="securityManager"/>
       <property name="filterChainDefinitions">
           <!--
            /login åŒ¿åè®¿é—®
            /** å‰©ä½™çš„å…¶ä»–æ¥å£ï¼Œéœ€è¦è®¤è¯æ‰èƒ½è®¿é—®
            -->
           <value>
               /login=anon
               /**=authc
           </value>
       </property>
   </bean>
   ```

2. ç™»å½•æ¥å£

   ```java
   /**
    * @Author yueyazhui
    * @Date 2023/2/18
    */
   @RestController
   public class LoginController {
   
       @PostMapping(value = "doLogin", produces = "text/html;charset=utf-8")
       public String doLogin(String username, String password) {
           UsernamePasswordToken usernamePasswordToken = new UsernamePasswordToken(username, password);
           try {
               // æ‰§è¡Œç™»å½•
               SecurityUtils.getSubject().login(usernamePasswordToken);
           } catch (AuthenticationException e) {
               return "ç™»å½•å¤±è´¥ï¼š" + e.getMessage();
           }
           return "ç™»å½•æˆåŠŸ";
       }
   }
   ```

## 4 ç™»å½•æµç¨‹

Shiroå®˜æ–¹æ–‡æ¡£ç™»å½•æµç¨‹å›¾ï¼š

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202302222223346.png)

æ­¥éª¤ï¼š

1. åº”ç”¨ç¨‹åºè°ƒç”¨ Subject.login æ–¹æ³•ï¼Œä¼ é€’åˆ›å»ºå¥½çš„åŒ…å«ç»ˆç«¯ç”¨æˆ·çš„ Principalsï¼ˆèº«ä»½ï¼‰å’Œ Credentialsï¼ˆå‡­è¯ï¼‰çš„ AuthenticationToken å®ä¾‹ï¼ˆUsernamePasswordTokenï¼‰ã€‚
2. Subject å®ä¾‹ï¼Œé€šå¸¸æ˜¯ DelegatingSubjectï¼ˆæˆ–å­ç±»ï¼‰å§”æ‰˜åº”ç”¨ç¨‹åºçš„ SecurityManager é€šè¿‡è°ƒç”¨securityManager.login(token) å¼€å§‹çœŸæ­£çš„éªŒè¯å·¥ä½œï¼ˆåœ¨ DelegatingSubject.login æ‰“æ–­ç‚¹æŸ¥çœ‹ï¼‰ã€‚
3. SecurityManager ä½œä¸ºä¸€ä¸ªåŸºæœ¬â€œä¿æŠ¤ä¼â€çš„ç»„æˆéƒ¨åˆ†ï¼Œæ¥æ”¶ token å¹¶é€šè¿‡è°ƒç”¨ authenticator.authenticate(token) ç®€å•åœ°å§”æ‰˜ç»™å†…éƒ¨çš„ Authenticator å®ä¾‹ã€‚Authenticator å®ä¾‹é€šå¸¸æ˜¯ä¸€ä¸ª ModularRealmAuthenticator å®ä¾‹ï¼Œæ”¯æŒåœ¨èº«ä»½éªŒè¯ä¸­åè°ƒä¸€ä¸ªæˆ–å¤šä¸ª Realm å®ä¾‹ã€‚ModularRealmAuthenticator æœ¬è´¨ä¸Šæ˜¯ Apache Shiro æä¾›äº† PAM-style èŒƒå¼ï¼ˆPAMï¼šæ¯ä¸ª Realm éƒ½æ˜¯ä¸€ä¸ª Moduleï¼‰ã€‚
4. å¦‚æœåœ¨åº”ç”¨ç¨‹åºä¸­é…ç½®äº†å¤šä¸ª Realmï¼ŒModularRealmAuthenticator å®ä¾‹å°†åˆ©ç”¨é…ç½®å¥½çš„ AuthenticationStrategy æ¥å¯åŠ¨ Multi-Realm è®¤è¯å°è¯•ã€‚åœ¨ Realms è¢«èº«ä»½éªŒè¯è°ƒç”¨ä¹‹å‰ï¼ŒæœŸé—´å’Œä¹‹åï¼ŒAuthenticationStrategy è¢«è°ƒç”¨ä½¿å…¶èƒ½å¤Ÿå¯¹æ¯ä¸ª Realm çš„ç»“æœä½œå‡ºååº”ã€‚å¦‚æœåªé…ç½®ä¸€ä¸ª Realm ï¼Œå®ƒå°†è¢«ç›´æ¥è°ƒç”¨ã€‚
5. é…ç½®çš„ Realm æ˜¯å¦æ”¯æŒæäº¤çš„ AuthenticationTokenã€‚å¦‚æœæ”¯æŒï¼ŒRealm çš„ getAuthenticationInfo æ–¹æ³•ä¼šä¼´éšç€æäº¤çš„ token è¢«è°ƒç”¨ã€‚

##  5 å¯†ç åŠ å¯†æ–¹æ¡ˆ

åŠ å¯†æ–¹æ¡ˆï¼š

* å¯é€†åŠ å¯†
  * å¯¹ç§°åŠ å¯†ï¼šDESã€3DESã€AES
  * éå¯¹ç§°åŠ å¯†ï¼šRSA
* ä¸å¯é€†åŠ å¯†
  * æ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼šMD5
  * å®‰å…¨æ•£åˆ—ç®—æ³•ï¼šSHA

å‰è½¦ä¹‹é‰´ï¼š

2011å¹´12æœˆ21æ—¥ï¼Œæœ‰äººåœ¨ç½‘ç»œä¸Šå…¬å¼€äº†ä¸€ä¸ªåŒ…å«600ä¸‡ä¸ªCSDNç”¨æˆ·èµ„æ–™çš„æ•°æ®åº“ï¼Œæ•°æ®å…¨éƒ¨ä¸ºæ˜æ–‡å‚¨å­˜ï¼ŒåŒ…å«ç”¨æˆ·åã€å¯†ç ä»¥åŠæ³¨å†Œé‚®ç®±ã€‚äº‹ä»¶å‘ç”ŸåCSDNåœ¨å¾®åšã€å®˜æ–¹ç½‘ç«™ç­‰æ¸ é“å‘å‡ºå£°æ˜ï¼Œè§£é‡Šè¯´æ­¤æ•°æ®åº“æ—¶2009å¹´å¤‡ä»½æ‰€ç”¨ï¼Œå› ä¸æ˜åŸå› æ³„éœ²ï¼Œå·²å‘è­¦æ–¹æŠ¥æ¡ˆã€‚ååˆåœ¨å®˜ç½‘ç½‘ç«™ä¸Šå‘å‡ºäº†å…¬å¼€é“æ­‰ä¿¡ã€‚åœ¨æ¥ä¸‹æ¥çš„åå¤šå¤©é‡Œï¼Œé‡‘å±±ã€ç½‘æ˜“ã€äº¬ä¸œã€å½“å½“ã€æ–°æµªç­‰å¤šå®¶å…¬å¸è¢«å·å…¥åˆ°è¿™æ¬¡äº‹ä»¶ä¸­ã€‚æ•´ä¸ªäº‹ä»¶ä¸­æœ€è§¦ç›®æƒŠå¿ƒçš„è«è¿‡äºCSDNæŠŠç”¨æˆ·å¯†ç æ˜æ–‡å­˜å‚¨ï¼Œç”±äºå¾ˆå¤šç”¨æˆ·æ˜¯å¤šä¸ªç½‘ç«™å…±ç”¨ä¸€ä¸ªå¯†ç ï¼Œå› æ­¤ä¸€ä¸ªç½‘ç«™å¯†ç æ³„éœ²å°±ä¼šé€ æˆå¾ˆå¤§çš„å®‰å…¨éšæ‚£ã€‚

å¯†ç åŠ å¯†ä¸€èˆ¬ä¼šç”¨åˆ°æ•£åˆ—å‡½æ•°ï¼Œåˆç§°æ•£åˆ—ç®—æ³•ã€å“ˆå¸Œå‡½æ•°ã€‚æ•£åˆ—å‡½æ•°æŠŠæ¶ˆæ¯æˆ–æ•°æ®å‹ç¼©æˆæ‘˜è¦ï¼Œä½¿å¾—æ•°æ®é‡å˜å°ï¼Œå°†æ•°æ®çš„æ ¼å¼å›ºå®šä¸‹æ¥ã€‚è¯¥å‡½æ•°å°†æ•°æ®æ‰“ä¹±æ··åˆï¼Œé‡æ–°åˆ›å»ºä¸€ä¸ªå«åšæ•£åˆ—å€¼çš„æŒ‡çº¹ã€‚æ•£åˆ—å€¼é€šå¸¸ç”¨ä¸€ä¸ªçŸ­çš„éšæœºå­—æ¯å’Œæ•°å­—ç»„æˆçš„å­—ç¬¦ä¸²æ¥ä»£è¡¨ã€‚å¥½çš„æ•£åˆ—å‡½æ•°åœ¨è¾“å…¥åŸŸä¸­å¾ˆå°‘å‡ºç°æ•£åˆ—å†²çªã€‚åœ¨æ•£åˆ—è¡¨å’Œæ•°æ®å¤„ç†ä¸­ï¼Œä¸æŠ‘åˆ¶å†²çªæ¥åŒºåˆ«æ•°æ®ï¼Œä¼šä½¿å¾—æ•°æ®åº“è®°å½•æ›´éš¾æ‰¾åˆ°ã€‚

å¸¸ç”¨çš„æ•£åˆ—å‡½æ•°ï¼š

1. MD5æ¶ˆæ¯æ‘˜è¦ç®—æ³•

MD5æ¶ˆæ¯æ‘˜è¦ç®—æ³•æ˜¯ä¸€ç§è¢«å¹¿æ³›ä½¿ç”¨çš„å¯†ç æ•£åˆ—å‡½æ•°ï¼Œå¯ä»¥äº§ç”Ÿå‡ºä¸€ä¸ª128ä½ï¼ˆ16å­—èŠ‚ï¼‰çš„æ•£åˆ—å€¼ï¼Œç”¨äºç¡®ä¿ä¿¡æ¯ä¼ è¾“å®Œæ•´ä¸€è‡´ã€‚MD5ç”±ç¾å›½å¯†ç å­¦å®¶ç½—çº³å¾·Â·æç»´æ–¯ç‰¹è®¾è®¡ï¼Œäº1992å¹´å…¬å¼€ï¼Œä»¥å–ä»£MD4ç®—æ³•ã€‚è¿™å¥—ç®—æ³•çš„ç¨‹åºåœ¨ RFC 1321 ä¸­è¢«åŠ ä»¥è§„èŒƒã€‚å°†æ•°æ®ï¼ˆå¦‚ä¸€æ®µæ–‡å­—ï¼‰è¿ç®—å˜ä¸ºå¦ä¸€å›ºå®šé•¿åº¦å€¼ï¼Œæ˜¯æ•£åˆ—ç®—æ³•çš„åŸºç¡€åŸç†ã€‚1996å¹´åè¢«è¯å®å­˜åœ¨å¼±ç‚¹ï¼Œå¯ä»¥è¢«åŠ ä»¥ç ´è§£ï¼Œå¯¹äºéœ€è¦é«˜åº¦å®‰å…¨æ€§çš„æ•°æ®ï¼Œä¸“å®¶ä¸€èˆ¬å»ºè®®æ”¹ç”¨å…¶ä»–ç®—æ³•ï¼Œå¦‚SHA-2ã€‚2004å¹´ï¼Œè¯å®MD5ç®—æ³•æ— æ³•é˜²æ­¢ç¢°æ’ï¼Œå› æ­¤ä¸é€‚ç”¨äºå®‰å…¨æ€§è®¤è¯ï¼Œå¦‚SSLå…¬å¼€å¯†é’¥è®¤è¯æˆ–æ˜¯æ•°å­—ç­¾åç­‰ç”¨é€”ã€‚

2. å®‰å…¨æ•£åˆ—ç®—æ³•

å®‰å…¨æ•£åˆ—ç®—æ³•ï¼ˆSecure Hash Algorithmï¼‰æ˜¯ä¸€ä¸ªå¯†ç æ•£åˆ—å‡½æ•°å®¶æ—ï¼Œæ˜¯ FIPS æ‰€è®¤è¯çš„å®‰å…¨æ•£åˆ—ç®—æ³•ã€‚èƒ½è®¡ç®—å‡ºä¸€ä¸ªæ•°å­—æ¶ˆæ¯æ‰€å¯¹åº”åˆ°çš„ã€é•¿åº¦å›ºå®šçš„å­—ç¬¦ä¸²ï¼ˆåˆç§°æ¶ˆæ¯æ‘˜è¦ï¼‰çš„ç®—æ³•ã€‚è¾“å…¥ç›¸åŒçš„æ¶ˆæ¯ï¼Œå®ƒä»¬å¯¹åº”åˆ°ä¸åŒå­—ç¬¦ä¸²çš„æœºç‡å¾ˆé«˜ã€‚SHAå®¶æ—çš„ç®—æ³•ï¼Œç”±ç¾å›½å›½å®¶å®‰å…¨å±€æ‰€è®¾è®¡ï¼Œå¹¶ç”±ç¾å›½å›½å®¶æ ‡å‡†ä¸æŠ€æœ¯ç ”ç©¶é™¢å‘å¸ƒï¼Œæ˜¯ç¾å›½çš„æ”¿åºœæ ‡å‡†ï¼Œå…¶åˆ†åˆ«æ˜¯ï¼šSHA-0ï¼š1993å¹´å‘å¸ƒï¼Œæ˜¯SHA-1çš„å‰èº«ï¼›SHA-1ï¼š1995å¹´å‘å¸ƒï¼ŒSHA-1åœ¨è®¸å¤šå®‰å…¨åè®®ä¸­å¹¿æ³›ä½¿ç”¨ï¼ŒåŒ…æ‹¬TLSå’ŒSSLã€PGPã€SSHã€S/MIMEå’ŒIPsecï¼Œæ›¾è¢«è§†ä¸ºæ˜¯MD5çš„åç»§è€…ã€‚ä½†SHA-1çš„å®‰å…¨æ€§åœ¨2000å¹´ä»¥åå·²ç»ä¸è¢«å¤§å¤šæ•°çš„åŠ å¯†åœºæ™¯æ‰€æ¥å—ã€‚2017å¹´è·å…°å¯†ç å­¦ç ”ç©¶å°ç»„CWIå’ŒGoogleæ­£å¼å®£å¸ƒæ”»ç ´äº†SHA-1ï¼›SHA-2ï¼š2001å¹´å‘å¸ƒï¼ŒåŒ…æ‹¬SHA-224ã€SHA-256ã€SHA-384ã€SHA-512ã€SHA-512/224ã€SHA-512/256ã€‚è™½ç„¶è‡³ä»Šå°šæœªå‡ºç°å¯¹SHA-2æœ‰æ•ˆçš„æ”»å‡»ï¼Œå®ƒçš„ç®—æ³•è·ŸSHA-1åŸºæœ¬ä¸Šä»ç„¶ç›¸ä¼¼ï¼›å› æ­¤æœ‰äº›äººå¼€å§‹å‘å±•å…¶ä»–å¯ä»¥æ›¿ä»£çš„æ•£åˆ—ç®—æ³•ï¼›SHA-3ï¼š2015å¹´æ­£å¼å‘å¸ƒï¼ŒSHA-3å¹¶ä¸æ˜¯è¦å–ä»£SHA-2ï¼Œå› ä¸ºSHA-2ç›®å‰å¹¶æ²¡æœ‰å‡ºç°æ˜æ˜¾çš„å¼±ç‚¹ã€‚ç”±äºå¯¹MD5å‡ºç°æˆåŠŸçš„ç ´è§£ï¼Œä»¥åŠå¯¹SHA-0å’ŒSHA-1å‡ºç°ç†è®ºä¸Šç ´è§£çš„æ–¹æ³•ï¼ŒNISTæ„Ÿè§‰éœ€è¦ä¸€ä¸ªä¸ä¹‹å‰ç®—æ³•ä¸åŒçš„ï¼Œå¯æ›¿æ¢çš„åŠ å¯†æ•£åˆ—ç®—æ³•ï¼Œä¹Ÿå°±æ˜¯ç°åœ¨çš„SHA-3ã€‚

åŠ å¯†æµ‹è¯•ï¼š

```java
@Test
public void test01() {
  Md5Hash md5Hash = new Md5Hash("123");
  log.info("ã€123ã€‘MD5åŠ å¯†åçš„å€¼ï¼š{}", md5Hash);
  Sha512Hash sha512Hash = new Sha512Hash("123");
  log.info("ã€123ã€‘Sha512åŠ å¯†åçš„å€¼ï¼š{}", sha512Hash);
  SimpleHash md5SimpleHash = new SimpleHash("md5", "123");
  log.info("ã€123ã€‘MD5åŠ å¯†åçš„å€¼ï¼š{}", md5SimpleHash);
  SimpleHash sha512SimpleHash = new SimpleHash("sha-512", "123");
  log.info("ã€123ã€‘Sha512åŠ å¯†åçš„å€¼ï¼š{}", sha512SimpleHash);
}
```

æ‰“å°ç»“æœï¼š

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202302232313717.png)

applicationContext.xml é…ç½® credentialsMatcherï¼ˆå¯†ç æ¯”å¯¹å™¨ï¼‰ï¼Œé…ç½® hashAlgorithmNameï¼ˆç®—æ³•åç§°ï¼‰

```xml
<bean class="top.yueyazhui.learn_shiro.realm.MyRealm01" id="myRealm">
  <property name="credentialsMatcher">
    <bean class="org.apache.shiro.authc.credential.HashedCredentialsMatcher">
      <property name="hashAlgorithmName" value="md5"/>
    </bean>
  </property>
</bean>
```

åŠ ç›æµ‹è¯•ï¼š

```Java
@Test
public void test02() {
  Md5Hash md5Hash = new Md5Hash("123", "yueyazhui", 1024);
  log.info("ã€123ã€‘MD5åŠ ç›åŠ å¯†åçš„å€¼ï¼š{}", md5Hash);
  SimpleHash md5SimpleHash = new SimpleHash("md5", "123", "yue", 1024);
  log.info("ã€123ã€‘MD5åŠ ç›åŠ å¯†åçš„å€¼ï¼š{}", md5SimpleHash);
}
```

æ‰“å°ç»“æœï¼š

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202302232326047.png)

applicationContext.xml é…ç½® hashIterationsï¼ˆè¿­ä»£æ¬¡æ•°ï¼‰

```Xml
<bean class="top.yueyazhui.learn_shiro.realm.MyRealm01" id="myRealm">
  <property name="credentialsMatcher">
    <bean class="org.apache.shiro.authc.credential.HashedCredentialsMatcher">
      <property name="hashAlgorithmName" value="md5"/>
      <property name="hashIterations" value="1024"/>
    </bean>
  </property>
</bean>
```

MyRealm01.java è¿”å›ç”¨æˆ·ä¿¡æ¯åŠ ç›

```java
/**
 * æ ¸å¿ƒæ–¹æ³•ï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
 *
 * @param authenticationToken åŒ…å«ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ç­‰ä¿¡æ¯
 * @return ä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯
 * @throws AuthenticationException
 */
@Override
protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
  UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) authenticationToken;
  // è·å–ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥çš„ç”¨æˆ·å
  String username = usernamePasswordToken.getUsername();
  User user = userService.getUserByUsername(username);
  if (ObjectUtil.isNull(user)) {
    throw new UnknownAccountException("ç”¨æˆ·åè¾“å…¥é”™è¯¯");
  }
  // è¿”å›æŸ¥è¯¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨æˆ·åã€å¯†ç ï¼‰
  //        return new SimpleAuthenticationInfo(user.getUsername(), user.getPassword(), getName());
  // è¿”å›æŸ¥è¯¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨æˆ·åã€å¯†ç ã€ç›ï¼‰
  return new SimpleAuthenticationInfo(user.getUsername(), user.getPassword(), ByteSource.Util.bytes(user.getUsername()), getName());
}
```

## 6 JdbcRealm

æ•°æ®åº“ï¼š

```sql
# ************************************************************
# Sequel Pro SQL dump
# Version 5446
#
# https://www.sequelpro.com/
# https://github.com/sequelpro/sequelpro
#
# Host: 127.0.0.1 (MySQL 8.0.27)
# Database: learn_shiro
# Generation Time: 2023-02-24 14:09:12 +0000
# ************************************************************


/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8 */;
SET NAMES utf8mb4;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;


# Dump of table roles_permissions
# ------------------------------------------------------------

DROP TABLE IF EXISTS `roles_permissions`;

CREATE TABLE `roles_permissions` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `permission` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT 'æƒé™',
  `role_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT 'è§’è‰²',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

LOCK TABLES `roles_permissions` WRITE;
/*!40000 ALTER TABLE `roles_permissions` DISABLE KEYS */;

INSERT INTO `roles_permissions` (`id`, `permission`, `role_name`)
VALUES
	(1,'book:*','manager'),
	(2,'author:create','manager');

/*!40000 ALTER TABLE `roles_permissions` ENABLE KEYS */;
UNLOCK TABLES;


# Dump of table user_roles
# ------------------------------------------------------------

DROP TABLE IF EXISTS `user_roles`;

CREATE TABLE `user_roles` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `role_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT 'è§’è‰²',
  `username` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT 'ç”¨æˆ·',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

LOCK TABLES `user_roles` WRITE;
/*!40000 ALTER TABLE `user_roles` DISABLE KEYS */;

INSERT INTO `user_roles` (`id`, `role_name`, `username`)
VALUES
	(1,'manager','yueyazhui');

/*!40000 ALTER TABLE `user_roles` ENABLE KEYS */;
UNLOCK TABLES;


# Dump of table users
# ------------------------------------------------------------

DROP TABLE IF EXISTS `users`;

CREATE TABLE `users` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `username` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT 'ç”¨æˆ·',
  `password` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT 'å¯†ç ',
  `password_salt` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT 'ç›',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

LOCK TABLES `users` WRITE;
/*!40000 ALTER TABLE `users` DISABLE KEYS */;

INSERT INTO `users` (`id`, `username`, `password`, `password_salt`)
VALUES
	(1,'yueyazhui','123',NULL);

/*!40000 ALTER TABLE `users` ENABLE KEYS */;
UNLOCK TABLES;



/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;
/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
```

applicationContext.xml é…ç½® JdbcRealm

```xml
<bean class="org.apache.shiro.realm.jdbc.JdbcRealm" id="jdbcRealm">
    <property name="dataSource" ref="dataSource"/>
    <bean class="org.apache.shiro.realm.jdbc.JdbcRealm" id="jdbcRealm">
        <property name="dataSource" ref="dataSource"/>
    </bean>
</bean>

<bean class="org.apache.shiro.web.mgt.DefaultWebSecurityManager" id="securityManager">
    <property name="realm" ref="jdbcRealm"/>
</bean>
```

å¯†ç åŠ å¯†åŠ ç›ï¼ŒapplicationContext.xml ç»™ JdbcRealm é…ç½® credentialsMatcherï¼ˆå¯†ç æ¯”å¯¹å™¨ï¼‰

```xml
<bean class="org.apache.shiro.realm.jdbc.JdbcRealm" id="jdbcRealm">
    <property name="dataSource" ref="dataSource"/>
    <bean class="org.apache.shiro.realm.jdbc.JdbcRealm" id="jdbcRealm">
        <property name="dataSource" ref="dataSource"/>
        <property name="credentialsMatcher">
          <bean class="org.apache.shiro.authc.credential.HashedCredentialsMatcher">
            <property name="hashAlgorithmName" value="md5"/>
            <property name="hashIterations" value="1024"/>
          </bean>
        </property>
      	<!-- columnï¼šè‡ªåŠ¨è¯»å–æ•°æ®åº“ä¸­çš„ç›å­—æ®µï¼Œé»˜è®¤çš„ç›å­—æ®µ password_salt -->
      	<!-- externalï¼šé»˜è®¤çš„ç›å­—æ®µ username -->
        <property name="saltStyle" value="COLUMN"/>
      	<!-- å£°æ˜ï¼šç›å­—æ®µæ²¡æœ‰è¿›è¡Œ base64 ç¼–ç ï¼Œæ— éœ€è§£ç  -->
        <property name="saltIsBase64Encoded" value="false"/>
    </bean>
</bean>
```

ä¿®æ”¹ users è¡¨ä¸­çš„ç›å­—æ®µï¼špassword_salt æ”¹ä¸º saltï¼Œé…ç½®è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯æŸ¥è¯¢è¯­å¥

```xml
<bean class="org.apache.shiro.realm.jdbc.JdbcRealm" id="jdbcRealm">
    <property name="dataSource" ref="dataSource"/>
    <bean class="org.apache.shiro.realm.jdbc.JdbcRealm" id="jdbcRealm">
        <property name="dataSource" ref="dataSource"/>
        <property name="credentialsMatcher">
          <bean class="org.apache.shiro.authc.credential.HashedCredentialsMatcher">
            <property name="hashAlgorithmName" value="md5"/>
            <property name="hashIterations" value="1024"/>
          </bean>
        </property>
      	<!-- columnï¼šè‡ªåŠ¨è¯»å–æ•°æ®åº“ä¸­çš„ç›å­—æ®µï¼Œé»˜è®¤çš„ç›å­—æ®µ password_salt -->
      	<!-- externalï¼šé»˜è®¤çš„ç›å­—æ®µ username -->
        <property name="saltStyle" value="COLUMN"/>
      	<!-- å£°æ˜ï¼šç›å­—æ®µæ²¡æœ‰è¿›è¡Œ base64 ç¼–ç ï¼Œæ— éœ€è§£ç  -->
        <property name="saltIsBase64Encoded" value="false"/>
      	<!-- è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯æŸ¥è¯¢SQL -->
        <property name="authenticationQuery" value="select password, salt from users where username = ?"/>
    </bean>
</bean>
```

## 7 å¤š Realm çš„ç­–ç•¥é…ç½®

å®šä¹‰ä¸¤ä¸ª Realmï¼Œå…¶ä¸­ MyRealm01 ä¸åšè®¤è¯ï¼Œåªæ˜¯ä¸ºäº†æµ‹è¯•å¤š Realm çš„è®¤è¯ç­–ç•¥

MyRealm01ï¼š

```Java
/**
 * @Author yueyazhui
 * @Date 2023/2/25
 *
 * ç»§æ‰¿ AuthenticatingRealm å¯ä»¥å®ç°è®¤è¯åŠŸèƒ½
 */
public class MyRealm01 extends AuthenticatingRealm {

    private UserService userService;

    public MyRealm01(UserService userService) {
        this.userService = userService;
    }

    /**
     * è¿™ä¸ª Realm ä¸åšè®¤è¯ï¼Œåªæ˜¯ä¸ºäº†æµ‹è¯•å¤š Realm çš„è®¤è¯ç­–ç•¥
     *
     * @param authenticationToken åŒ…å«ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ç­‰ä¿¡æ¯
     * @return ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ç­‰ä¿¡æ¯
     * @throws AuthenticationException
     */
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
        UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) authenticationToken;
        // è¿”å›çš„å¯†ç å°±æ˜¯ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥çš„å¯†ç ï¼Œæ‰€ä»¥ä¸ç®¡ç”¨æˆ·å¡«ä»€ä¹ˆç”¨æˆ·åå’Œå¯†ç éƒ½å¯ä»¥è®¤è¯æˆåŠŸ
        return new SimpleAuthenticationInfo("yue", usernamePasswordToken.getPassword(), getName());
    }
}
```

MyRealm02ï¼š

```java
/**
 * @Author yueyazhui
 * @Date 2023/2/25
 *
 * ç»§æ‰¿ AuthenticatingRealm å¯ä»¥å®ç°è®¤è¯åŠŸèƒ½
 */
public class MyRealm02 extends AuthenticatingRealm {

    private UserService userService;

    public MyRealm02(UserService userService) {
        this.userService = userService;
    }

    /**
     * æ ¸å¿ƒæ–¹æ³•ï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
     *
     * @param authenticationToken åŒ…å«ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ç­‰ä¿¡æ¯
     * @return ä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯
     * @throws AuthenticationException
     */
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
        UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) authenticationToken;
        // è·å–ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥çš„ç”¨æˆ·å
        String username = usernamePasswordToken.getUsername();
        User user = userService.getUserByUsername(username);
        if (ObjectUtil.isNull(user)) {
            throw new UnknownAccountException("ç”¨æˆ·åè¾“å…¥é”™è¯¯");
        }
        // è¿”å›æŸ¥è¯¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨æˆ·åã€å¯†ç ã€ç›ï¼‰
        return new SimpleAuthenticationInfo(user.getUsername(), user.getPassword(), getName());
    }
}
```

ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨ç™»å½•çš„æ–¹æ³•ä¸­ï¼Œæ‰“å°è®¤è¯æˆåŠŸ Realm è¿”å›çš„ä¿¡æ¯

```java
@PostMapping(value = "login", produces = "text/html;charset=utf-8")
public String login(String username, String password) {
  UsernamePasswordToken usernamePasswordToken = new UsernamePasswordToken(username, password);
  try {
    // æ‰§è¡Œç™»å½•
    Subject subject = SecurityUtils.getSubject();
    subject.login(usernamePasswordToken);
    List list = subject.getPrincipals().asList();
    for (Object o : list) {
      System.out.println("o = " + o);
    }
  } catch (AuthenticationException e) {
    return "ç™»å½•å¤±è´¥ï¼š" + e.getMessage();
  }
  return "ç™»å½•æˆåŠŸ";
}
```

### 7.1 ä¸‰ç§è®¤è¯ç­–ç•¥

#### 1. AtLeastOneSuccessfulStrategy

è‡³å°‘æœ‰ä¸€ä¸ª Realm è®¤è¯æˆåŠŸæ‰ç®—æˆåŠŸï¼Œå¦‚æœæœ‰å¤šä¸ª Realm è®¤è¯æˆåŠŸï¼Œé‚£ä¹ˆä¼šè¿”å›æ‰€æœ‰è®¤è¯æˆåŠŸ Realm çš„ä¿¡æ¯

```xml
<bean class="org.apache.shiro.web.mgt.DefaultWebSecurityManager" id="securityManager">
  <property name="authenticator">
    <bean class="org.apache.shiro.authc.pam.ModularRealmAuthenticator">
      <property name="realms">
        <list>
          <!-- é¡ºåºå¾ˆå…³é”®ï¼Œè®¤è¯çš„æ—¶å€™ä¼šæŒ‰ç…§è¿™ä¸ªé¡ºåºå»è®¤è¯ -->
          <ref bean="myRealm01"/>
          <ref bean="myRealm02"/>
        </list>
      </property>
      <property name="authenticationStrategy">
        <!-- è‡³å°‘æœ‰ä¸€ä¸ª Realm è®¤è¯æˆåŠŸæ‰ç®—æˆåŠŸï¼Œå¦‚æœæœ‰å¤šä¸ª Realm è®¤è¯æˆåŠŸï¼Œé‚£ä¹ˆä¼šè¿”å›æ‰€æœ‰è®¤è¯æˆåŠŸ Realm çš„ä¿¡æ¯ -->
        <bean class="org.apache.shiro.authc.pam.AtLeastOneSuccessfulStrategy"/>
      </property>
    </bean>
  </property>
</bean>
```

æ‰“å°ç»“æœï¼š

```Txt
o = yue
o = yueyazhui
```
#### 2. FirstSuccessfulStrategy

åªè¿”å›ç¬¬ä¸€ä¸ªè®¤è¯æˆåŠŸçš„ Realm ä¿¡æ¯ï¼›é»˜è®¤æƒ…å†µä¸‹ï¼Œå³ä½¿å·²ç»æœ‰ Realm è®¤è¯æˆåŠŸï¼Œå‰©ä¸‹çš„ Realm è¿˜ä¼šç»§ç»­è¿›è¡Œè®¤è¯æ“ä½œ

```Xml
<bean class="org.apache.shiro.web.mgt.DefaultWebSecurityManager" id="securityManager">
  <property name="authenticator">
    <bean class="org.apache.shiro.authc.pam.ModularRealmAuthenticator">
      <property name="realms">
        <list>
          <!-- é¡ºåºå¾ˆå…³é”®ï¼Œè®¤è¯çš„æ—¶å€™ä¼šæŒ‰ç…§è¿™ä¸ªé¡ºåºå»è®¤è¯ -->
          <ref bean="myRealm01"/>
          <ref bean="myRealm02"/>
        </list>
      </property>
      <property name="authenticationStrategy">
        <!-- åªè¿”å›ç¬¬ä¸€ä¸ªè®¤è¯æˆåŠŸçš„ Realm ä¿¡æ¯ï¼›é»˜è®¤æƒ…å†µä¸‹ï¼Œå³ä½¿å·²ç»æœ‰ Realm è®¤è¯æˆåŠŸï¼Œå‰©ä¸‹çš„ Realm è¿˜ä¼šç»§ç»­è¿›è¡Œè®¤è¯æ“ä½œ -->
        <bean class="org.apache.shiro.authc.pam.FirstSuccessfulStrategy"/>
      </property>
    </bean>
  </property>
</bean>
```

æ‰“å°ç»“æœï¼š

```txt
o = yue
```
#### 3. AllSuccessfulStrategy

å¿…é¡»æ‰€æœ‰çš„ Realm éƒ½è®¤è¯æˆåŠŸï¼Œæ‰ç®—è®¤è¯æˆåŠŸ

```xml
<bean class="top.yueyazhui.learn_shiro.realm.MyRealm01" id="myRealm01"/>

<bean class="top.yueyazhui.learn_shiro.realm.MyRealm02" id="myRealm02"/>

<bean class="org.apache.shiro.web.mgt.DefaultWebSecurityManager" id="securityManager">
  <property name="authenticator">
    <bean class="org.apache.shiro.authc.pam.ModularRealmAuthenticator">
      <property name="realms">
        <list>
          <!-- é¡ºåºå¾ˆå…³é”®ï¼Œè®¤è¯çš„æ—¶å€™ä¼šæŒ‰ç…§è¿™ä¸ªé¡ºåºå»è®¤è¯ -->
          <ref bean="myRealm01"/>
          <ref bean="myRealm02"/>
        </list>
      </property>
      <property name="authenticationStrategy">
        <!-- å¿…é¡»æ‰€æœ‰çš„ Realm éƒ½è®¤è¯æˆåŠŸï¼Œæ‰ç®—è®¤è¯æˆåŠŸ -->
        <bean class="org.apache.shiro.authc.pam.AllSuccessfulStrategy"/>
      </property>
    </bean>
  </property>
</bean>
```

æ‰“å°ç»“æœï¼š

```txt
o = yue
```
### 7.2 æºç åˆ†æ

#### 1. ModularRealmAuthenticator

##### 1.1 Realm

Realmï¼Œå¯ä»¥ç›´æ¥é…ç½®ç»™ SecurityManagerï¼Œä¹Ÿå¯ä»¥é…ç½®ç»™ SecurityManager ä¸­çš„ ModularRealmAuthenticatorã€‚

å¦‚æœæ˜¯ç›´æ¥é…ç½®ç»™ SecurityManagerï¼Œé‚£ä¹ˆåœ¨å®Œæˆ Realm çš„é…ç½®åï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ afterRealmsSet æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šå°†é…ç½®çš„æ‰€æœ‰ Realm é…ç½®ç»™ ModularRealmAuthenticatorã€‚

ç›¸å…³æºç å¦‚ä¸‹ï¼š

RealmSecurityManager#setRealmï¼ˆRealmSecurityManager æ˜¯ DefaultWebSecurityManager çš„çˆ¶ç±»ï¼‰

```java
public void setRealm(Realm realm) {
    if (realm == null) {
        throw new IllegalArgumentException("Realm argument cannot be null");
    }
    Collection<Realm> realms = new ArrayList<Realm>(1);
    realms.add(realm);
    setRealms(realms);
}
public void setRealms(Collection<Realm> realms) {
    if (realms == null) {
        throw new IllegalArgumentException("Realms collection argument cannot be null.");
    }
    if (realms.isEmpty()) {
        throw new IllegalArgumentException("Realms collection argument cannot be empty.");
    }
    this.realms = realms;
    afterRealmsSet();
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯è®¾ç½®å•ä¸ª Realm è¿˜æ˜¯è®¾ç½®å¤šä¸ª Realmï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ° afterRealmsSet æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨ AuthorizingSecurityManager#afterRealmsSet ç±»ä¸­è¢«é‡å†™ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```java
protected void afterRealmsSet() {
    super.afterRealmsSet();
    if (this.authorizer instanceof ModularRealmAuthorizer) {
        ((ModularRealmAuthorizer) this.authorizer).setRealms(getRealms());
    }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæ‰€æœ‰çš„ Realm æœ€ç»ˆéƒ½è¢«é…ç½®ç»™ ModularRealmAuthenticator äº†ã€‚

**æ— è®ºæ˜¯å•ä¸ª Realm è¿˜æ˜¯å¤šä¸ª Realmï¼Œæœ€ç»ˆéƒ½æ˜¯ç”± ModularRealmAuthenticator ç»Ÿä¸€ç®¡ç†ç»Ÿä¸€è°ƒç”¨çš„ã€‚**

##### 1.2 ModularRealmAuthenticator

ModularRealmAuthenticator ä¸­æ ¸å¿ƒçš„æ–¹æ³•å°±æ˜¯ doAuthenticateï¼Œå¦‚ä¸‹ï¼š

```java
protected AuthenticationInfo doAuthenticate(AuthenticationToken authenticationToken) throws AuthenticationException {
    assertRealmsConfigured();
    Collection<Realm> realms = getRealms();
    if (realms.size() == 1) {
        return doSingleRealmAuthentication(realms.iterator().next(), authenticationToken);
    } else {
        return doMultiRealmAuthentication(realms, authenticationToken);
    }
}
```

è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘å¾ˆç®€å•ï¼š

1. é¦–å…ˆè°ƒç”¨ assertRealmsConfigured æ–¹æ³•åˆ¤æ–­ä¸€ä¸‹å¼€å‘è€…æœ‰æ²¡æœ‰é…ç½® Realmï¼Œè¦æ˜¯æ²¡æœ‰é…ç½®å°±ç›´æ¥æŠ›å¼‚å¸¸ã€‚
2. åˆ¤æ–­å¼€å‘è€…é…ç½®äº†å‡ ä¸ª Realmï¼Œè¦æ˜¯é…ç½®äº†ä¸€ä¸ªï¼Œå°±è°ƒç”¨ doSingleRealmAuthentication æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œè¦æ˜¯é…ç½®äº†å¤šä¸ª Realm åˆ™è°ƒç”¨ doMultiRealmAuthentication æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚

å¦‚æœå­˜åœ¨å¤šä¸ª Realmï¼Œå¿…ç„¶ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼š**è®¤è¯ç­–ç•¥**ï¼Ÿä¸€ä¸ª Realm è®¤è¯æˆåŠŸå°±ç®—æˆåŠŸè¿˜æ˜¯æ‰€æœ‰ Realm è®¤è¯æˆåŠŸæ‰ç®—æˆåŠŸï¼Ÿ

#### 2. AuthenticationStrategy

æ•´ä½“ä¸Šçœ‹ï¼Œè´Ÿè´£è®¤è¯ç­–ç•¥çš„ç±»æ˜¯ AuthenticationStrategyï¼Œè¿™æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ‰ä¸‰ä¸ªå®ç°ç±»ï¼š

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303062256006.png)

å•ä»å­—é¢ä¸Šæ¥çœ‹ï¼Œä¸‰ä¸ªå®ç°ç±»éƒ½å¥½ç†è§£ï¼š

- AtLeastOneSuccessfulStrategyï¼šè‡³å°‘æœ‰ä¸€ä¸ª Realm è®¤è¯æˆåŠŸã€‚
- AllSuccessfulStrategyï¼šæ‰€æœ‰ Realm éƒ½è¦è®¤è¯æˆåŠŸã€‚
- FirstSuccessfulStrategyï¼šåªè¿”å›ç¬¬ä¸€ä¸ªè®¤è¯æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ã€‚

ç–‘é—®ï¼šç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªçš„åŒºåˆ«åœ¨å“ªï¼Ÿï¼Ÿï¼Ÿ

é¦–å…ˆè¿™é‡Œä¸€å…±æ¶‰åŠåˆ°å››ä¸ªæ–¹æ³•ï¼š

- beforeAllAttemptsï¼šåœ¨æ‰€æœ‰ Realm éªŒè¯ä¹‹å‰åšå‡†å¤‡ã€‚
- beforeAttemptï¼šåœ¨å•ä¸ª Realm éªŒè¯ä¹‹å‰åšå‡†å¤‡ã€‚
- afterAttemptï¼šå¤„ç†å•ä¸ª Realm éªŒè¯ä¹‹åçš„åç»­äº‹å®œã€‚
- afterAllAttemptsï¼šå¤„ç†æ‰€æœ‰ Realm éªŒè¯ä¹‹åçš„åç»­äº‹å®œã€‚

ç¬¬ä¸€ä¸ªå’Œç¬¬å››ä¸ªæ–¹æ³•åœ¨æ¯æ¬¡è®¤è¯æµç¨‹ä¸­åªè°ƒç”¨ä¸€æ¬¡ï¼Œè€Œä¸­é—´ä¸¤ä¸ªæ–¹æ³•åˆ™åœ¨æ¯ä¸ª Realm è°ƒç”¨å‰åéƒ½ä¼šè¢«è°ƒç”¨åˆ°ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303062304034.png)

è¿™å››ä¸ªæ–¹æ³•ï¼Œåœ¨ AuthenticationStrategy çš„å››ä¸ªå®ç°ç±»ä¸­æœ‰ä¸åŒçš„å®ç°ï¼Œå…³ç³»å¦‚ä¸‹ï¼š

|                   | AbstractAuthenticationStrategy | AtLeastOneSuccessfulStrategy | AllSuccessfulStrategy | FirstSuccessfulStrategy |
| ----------------- | :----------------------------: | :--------------------------: | :-------------------: | :---------------------: |
| beforeAllAttempts |               âœ”ï¸               |                              |                       |           âœ”ï¸            |
| beforeAttempt     |               âœ”ï¸               |                              |          âœ”ï¸           |           âœ”ï¸            |
| afterAttempt      |               âœ”ï¸               |                              |          âœ”ï¸           |                         |
| afterAllAttempts  |               âœ”ï¸               |              âœ”ï¸              |                       |                         |
| merge             |               âœ”ï¸               |                              |                       |           âœ”ï¸            |

merge æ–¹æ³•æ˜¯åœ¨ AbstractAuthenticationStrategy ç±»ä¸­å®šä¹‰çš„ï¼Œå½“å­˜åœ¨å¤šä¸ª Realm æ—¶ï¼Œåˆå¹¶å¤šä¸ª Realm ä¸­çš„è®¤è¯ä¿¡æ¯ä½¿ç”¨çš„ã€‚

##### 2.1 AbstractAuthenticationStrategy

###### 2.1.1 beforeAllAttempts

```java
public AuthenticationInfo beforeAllAttempts(Collection<? extends Realm> realms, AuthenticationToken token) throws AuthenticationException {
    return new SimpleAuthenticationInfo();
}
```

åˆ›å»ºäº†ä¸€ä¸ªç©ºçš„ SimpleAuthenticationInfo å¯¹è±¡

###### 2.1.2 beforeAttempt

```java
public AuthenticationInfo beforeAttempt(Realm realm, AuthenticationToken token, AuthenticationInfo aggregate) throws AuthenticationException {
    return aggregate;
}
```

ä¼ å…¥çš„ aggregate å‚æ•°æ˜¯æŒ‡å¤šä¸ª Realm è®¤è¯åèšåˆçš„ç»“æœã€‚

###### 2.1.3 afterAttempt

```java
public AuthenticationInfo afterAttempt(Realm realm, AuthenticationToken token, AuthenticationInfo singleRealmInfo, AuthenticationInfo aggregateInfo, Throwable t) throws AuthenticationException {
    AuthenticationInfo info;
    if (singleRealmInfo == null) {
        info = aggregateInfo;
    } else {
        if (aggregateInfo == null) {
            info = singleRealmInfo;
        } else {
            info = merge(singleRealmInfo, aggregateInfo);
        }
    }
    return info;
}
```

è¿™æ˜¯æ¯ä¸ª Realm è®¤è¯å®Œæˆåè°ƒç”¨çš„æ–¹æ³•ï¼Œå‚æ•° singleRealmInfo è¡¨ç¤ºå•ä¸ª Realm è®¤è¯çš„ç»“æœï¼ŒaggregateInfo è¡¨ç¤ºå¤šä¸ª Realm è®¤è¯èšåˆçš„ç»“æœï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š

1. å¦‚æœå½“å‰ Realm è®¤è¯ç»“æœä¸º nullï¼Œåˆ™æŠŠèšåˆçš„ç»“æœèµ‹å€¼ç»™ info å¹¶è¿”å›ã€‚
2. å¦‚æœå½“å‰ Realm è®¤è¯ç»“æœä¸ä¸º nullï¼Œå¹¶ä¸”èšåˆç»“æœä¸º nullï¼Œé‚£ä¹ˆå°±æŠŠå½“å‰ Realm çš„è®¤è¯ç»“æœèµ‹å€¼ç»™ info å¹¶è¿”å›ã€‚
3. å¦‚æœå½“å‰ Realm è®¤è¯ç»“æœä¸ä¸º nullï¼Œå¹¶ä¸”èšåˆç»“æœä¹Ÿä¸ä¸º nullï¼Œåˆ™å°†ä¸¤è€…åˆå¹¶ä¹‹åè¿”å›ã€‚

###### 2.1.4 afterAllAttempts

```java
public AuthenticationInfo afterAllAttempts(AuthenticationToken token, AuthenticationInfo aggregate) throws AuthenticationException {
    return aggregate;
}
```

###### 2.1.5 merge

```java
protected AuthenticationInfo merge(AuthenticationInfo info, AuthenticationInfo aggregate) {
    if( aggregate instanceof MergableAuthenticationInfo ) {
        ((MergableAuthenticationInfo)aggregate).merge(info);
        return aggregate;
    } else {
        throw new IllegalArgumentException( "Attempt to merge authentication info from multiple realms, but aggregate " +
                  "AuthenticationInfo is not of type MergableAuthenticationInfo." );
    }
}
```

merge å…¶å®å°±æ˜¯è°ƒç”¨ aggregate çš„ merge æ–¹æ³•è¿›è¡Œåˆå¹¶ï¼Œæ­£å¸¸æƒ…å†µä¸‹ SimpleAuthenticationInfo å°±æ˜¯ MergableAuthenticationInfo çš„å­ç±»ï¼Œæ‰€ä»¥è¿™é‡Œåˆå¹¶æ²¡é—®é¢˜ã€‚

##### 2.2 AtLeastOneSuccessfulStrategy

###### 2.2.1 beforeAllAttempts

åŒ 2.1.1 å°èŠ‚ã€‚

###### 2.2.2 beforeAttempt

åŒ 2.1.2 å°èŠ‚ã€‚

###### 2.2.3 afterAttempt

åŒ 2.1.3 å°èŠ‚ã€‚

###### 2.2.4 afterAllAttempts

```java
public AuthenticationInfo afterAllAttempts(AuthenticationToken token, AuthenticationInfo aggregate) throws AuthenticationException {
    //we know if one or more were able to successfully authenticate if the aggregated account object does not
    //contain null or empty data:
    if (aggregate == null || isEmpty(aggregate.getPrincipals())) {
        throw new AuthenticationException("Authentication token of type [" + token.getClass() + "] " +
                "could not be authenticated by any configured realms.  Please ensure that at least one realm can " +
                "authenticate these tokens.");
    }
    return aggregate;
}
```

å½“èšåˆç»“æœä¸ºç©ºæ—¶æŠ›å‡ºå¼‚å¸¸ã€‚

###### 2.2.5 merge

åŒ 2.1.5 å°èŠ‚ã€‚

###### 2.2.6 å°ç»“

æ¢³ç† AtLeastOneSuccessfulStrategy çš„åŠŸèƒ½ã€‚

1. é¦–å…ˆï¼Œç³»ç»Ÿè°ƒç”¨ beforeAllAttempts æ–¹æ³•ä¼šè·å–ä¸€ä¸ªç©ºçš„ SimpleAuthenticationInfo å¯¹è±¡ä½œä¸ºèšåˆç»“æœ aggregateã€‚
2. æ¥ä¸‹æ¥éå†æ‰€æœ‰çš„ Realmï¼Œåœ¨æ¯ä¸ª Realm è°ƒç”¨ä¹‹å‰å…ˆè°ƒç”¨ beforeAttempt æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šåŸå°ä¸åŠ¨çš„è¿”å›èšåˆç»“æœ aggregateã€‚
3. è°ƒç”¨æ¯ä¸ª Realm çš„ getAuthenticationInfo æ–¹æ³•è¿›è¡Œè®¤è¯ã€‚
4. è°ƒç”¨ afterAttempt æ–¹æ³•å¯¹è®¤è¯ç»“æœè¿›è¡Œèšåˆå¤„ç†ã€‚å¦‚æœå½“å‰ Realm è®¤è¯è¿”å› nullï¼Œå°±æŠŠèšåˆç»“æœè¿”å›ï¼›å¦‚æœå½“å‰ Realm è®¤è¯ä¸è¿”å› nullï¼Œå°±æŠŠ å½“å‰çš„ Realm çš„è®¤è¯ç»“æœå’Œ aggregate è¿›è¡Œåˆå¹¶åè¿”å›ï¼ˆaggregate ä¸ä¼šä¸º nullï¼Œå› ä¸º beforeAllAttempts æ–¹æ³•ä¸­å·²ç»åˆ›å»ºäº†ä¸€ä¸ªç©ºå¯¹è±¡ï¼‰ã€‚

è¿™å°±æ˜¯ AtLeastOneSuccessfulStrategy çš„è®¤è¯ç­–ç•¥ã€‚**å¦‚æœåªæœ‰ä¸€ä¸ª Realm è®¤è¯æˆåŠŸï¼Œé‚£ä¹ˆè¿”å›ä¸€ä¸ªè®¤è¯ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå¦‚æœæœ‰å¤šä¸ª Realm è®¤è¯æˆåŠŸï¼Œé‚£ä¹ˆè¿”å›çš„ç”¨æˆ·ä¿¡æ¯ä¸­å°†åŒ…å«å¤šä¸ªè®¤è¯ç”¨æˆ·çš„ä¿¡æ¯ã€‚**

å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è·å–è¿”å›çš„å¤šä¸ªç”¨æˆ·ä¿¡æ¯ï¼š

```java
Subject subject = SecurityUtils.getSubject();
subject.login(token);
PrincipalCollection principals = subject.getPrincipals();
List list = principals.asList();
for (Object o : list) {
    System.out.println("o = " + o);
}
```

subject.getPrincipals() æ–¹æ³•å¯ä»¥è·å–å¤šä¸ªè®¤è¯æˆåŠŸçš„å‡­è¯ã€‚

##### 2.3 AllSuccessfulStrategy

###### 2.3.1 beforeAllAttempts

åŒ 2.1.1 å°èŠ‚ã€‚

###### 2.3.2 beforeAttempt

```java
public AuthenticationInfo beforeAttempt(Realm realm, AuthenticationToken token, AuthenticationInfo info) throws AuthenticationException {
    if (!realm.supports(token)) {
        String msg = "Realm [" + realm + "] of type [" + realm.getClass().getName() + "] does not support " +
                " the submitted AuthenticationToken [" + token + "].  The [" + getClass().getName() +
                "] implementation requires all configured realm(s) to support and be able to process the submitted " +
                "AuthenticationToken.";
        throw new UnsupportedTokenException(msg);
    }
    return info;
}
```

å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå°±æ˜¯å»æ£€æŸ¥ä¸€ä¸‹ Realm æ˜¯å¦æ”¯æŒå½“å‰ tokenã€‚

###### 2.3.3 afterAttempt

```java
public AuthenticationInfo afterAttempt(Realm realm, AuthenticationToken token, AuthenticationInfo info, AuthenticationInfo aggregate, Throwable t)
        throws AuthenticationException {
    if (t != null) {
        if (t instanceof AuthenticationException) {
            throw ((AuthenticationException) t);
        } else {
            String msg = "Unable to acquire account data from realm [" + realm + "].  The [" +
                    getClass().getName() + " implementation requires all configured realm(s) to operate successfully " +
                    "for a successful authentication.";
            throw new AuthenticationException(msg, t);
        }
    }
    if (info == null) {
        String msg = "Realm [" + realm + "] could not find any associated account data for the submitted " +
                "AuthenticationToken [" + token + "].  The [" + getClass().getName() + "] implementation requires " +
                "all configured realm(s) to acquire valid account data for a submitted token during the " +
                "log-in process.";
        throw new UnknownAccountException(msg);
    }
    merge(info, aggregate);
    return aggregate;
}
```

å¦‚æœå½“å‰è®¤è¯å‡ºé”™ï¼Œæˆ–è€…è®¤è¯ç»“æœä¸º nullï¼Œå°±ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼ˆå› ä¸ºè¿™é‡Œè¦æ±‚æ¯ä¸ª Realm éƒ½è®¤è¯æˆåŠŸï¼Œä½†å‡¡æœ‰ä¸€ä¸ªè®¤è¯å¤±è´¥ï¼Œåé¢çš„å°±æ²¡æœ‰å¿…è¦è®¤è¯äº†ï¼‰ã€‚

å¦‚æœå…¨éƒ¨è®¤è¯æˆåŠŸï¼Œå°±ä¼šæŠŠåˆå¹¶åçš„ç»“æœè¿”å›ã€‚

###### 2.3.4 afterAllAttempts

åŒ 2.1.4 å°èŠ‚ã€‚

###### 2.3.5 merge

åŒ 2.1.5 å°èŠ‚ã€‚

###### 2.3.6 å°ç»“

å¦‚æœæœ‰å¤šä¸ª Realm è®¤è¯æˆåŠŸï¼Œé‚£ä¹ˆä¼šè¿”å›å¤šä¸ª Realm çš„è®¤è¯ä¿¡æ¯ã€‚

##### 2.4 FirstSuccessfulStrategy

###### 2.4.1 beforeAllAttempts

```java
public AuthenticationInfo beforeAllAttempts(Collection<? extends Realm> realms, AuthenticationToken token) throws AuthenticationException {
    return null;
}
```

ç›´æ¥è¿”å› nullã€‚

###### 2.4.2 beforeAttempt

```java
public AuthenticationInfo beforeAttempt(Realm realm, AuthenticationToken token, AuthenticationInfo aggregate) throws AuthenticationException {
    if (getStopAfterFirstSuccess() && aggregate != null && !isEmpty(aggregate.getPrincipals())) {
        throw new ShortCircuitIterationException();
    }
    return aggregate;
}
```

å¦‚æœ getStopAfterFirstSuccess() æ–¹æ³•è¿”å› trueï¼Œå¹¶ä¸”å½“å‰è®¤è¯ç»“æœçš„èšåˆä¸ä¸ºç©ºï¼Œé‚£ä¹ˆå°±ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸€æ—¦æŠ›å‡ºå¼‚å¸¸ï¼Œå°±ä¼šè·³å‡ºå½“å‰å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šè°ƒç”¨å½“å‰ Realm è¿›è¡Œè®¤è¯æ“ä½œäº†ã€‚

getStopAfterFirstSuccess() æ–¹æ³•ï¼Œæ˜¯å¦åœ¨ç¬¬ä¸€æ¬¡æˆåŠŸååœæ­¢è®¤è¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å˜é‡ä¸º falseï¼Œå³å³ä½¿ç¬¬ä¸€æ¬¡è®¤è¯æˆåŠŸï¼Œä¹Ÿè¿˜æ˜¯ä¼šç»§ç»­åé¢ Realm è®¤è¯ã€‚

å¦‚æœæƒ³å½“ç¬¬ä¸€æ¬¡è®¤è¯æˆåŠŸåï¼Œåé¢çš„ Realm å°±ä¸è®¤è¯äº†ï¼Œé‚£ä¹ˆéœ€è¦å°†è¯¥å±æ€§é…ç½®ä¸º trueã€‚

###### 2.4.3 afterAttempt

åŒ 2.1.3 å°èŠ‚ã€‚

###### 2.4.4 afterAllAttempts

åŒ 2.1.4 å°èŠ‚ã€‚

###### 2.4.5 merge

å¦‚æœå½“å‰ Realm çš„è®¤è¯å’Œèšåˆç»“æœéƒ½ä¸ä¸º nullï¼Œå°±éœ€è¦å¯¹ç»“æœè¿›è¡Œåˆå¹¶ï¼ŒåŸæœ¬çš„åˆå¹¶æ˜¯çœŸçš„å»åˆå¹¶ï¼Œè¿™é‡Œé‡å†™è¯¥æ–¹æ³•ï¼Œå°±æ²¡æœ‰å»æ‰§è¡Œåˆå¹¶äº†ã€‚

```java
protected AuthenticationInfo merge(AuthenticationInfo info, AuthenticationInfo aggregate) {
    if (aggregate != null && !isEmpty(aggregate.getPrincipals())) {
        return aggregate;
    }
    return info != null ? info : aggregate;
}
```

è¿™æ˜¯ä¸‰ä¸ªç­–ç•¥ä¸­ï¼Œå”¯ä¸€é‡å†™ merge æ–¹æ³•çš„ã€‚

è¿™é‡Œçš„ merge å¹¶æ²¡æœ‰çœŸæ­£çš„ mergeï¼Œè€Œæ˜¯ï¼š

1. å¦‚æœèšåˆç»“æœä¸ä¸ºç©ºï¼Œå°±ç›´æ¥è¿”å›èšåˆç»“æœã€‚
2. å¦åˆ™ï¼Œå¦‚æœå½“å‰è®¤è¯ç»“æœä¸ä¸ºç©ºï¼Œå°±è¿”å›å½“å‰è®¤è¯ç»“æœã€‚
3. å¦åˆ™è¿”å›ç©ºã€‚

###### 2.4.6 å°ç»“

æ€»ç»“ FirstSuccessfulStrategy å’Œ AtLeastOneSuccessfulStrategy çš„åŒºåˆ«ï¼š

1. AtLeastOneSuccessfulStrategyï¼šå½“å­˜åœ¨å¤šä¸ª Realm æ—¶ï¼Œå³ä½¿å·²ç»æœ‰ä¸€ä¸ª Realm è®¤è¯æˆåŠŸï¼Œåé¢çš„ Realm ä¹Ÿè¿˜æ˜¯ä¼šå»è®¤è¯ï¼Œå¹¶ä¸”å¦‚æœåé¢çš„ Realm ä¹Ÿè®¤è¯æˆåŠŸäº†ï¼Œé‚£ä¹ˆä¼šå°†å¤šä¸ª Realm è®¤è¯æˆåŠŸçš„ç»“æœè¿›è¡Œåˆå¹¶åè¿”å›ã€‚
2. FirstSuccessfulStrategyï¼šå½“å­˜åœ¨å¤šä¸ª Realm æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå³ä½¿å·²ç»æœ‰ä¸€ä¸ª Realm è®¤è¯æˆåŠŸï¼Œåé¢çš„ Realm ä¹Ÿè¿˜æ˜¯ä¼šå»è®¤è¯ï¼Œä½†æ˜¯å¦‚æœåé¢çš„ Realm ä¹Ÿè®¤è¯æˆåŠŸäº†ï¼Œå´å¹¶ä¸ä¼šä½¿ç”¨åé¢è®¤è¯æˆåŠŸçš„ Realm è¿”å›çš„ç»“æœã€‚å¦‚æœå¸Œæœ›å½“ä¸€ä¸ª Realm è®¤è¯æˆåŠŸåï¼Œåé¢çš„ Realm å°±ä¸å†è®¤è¯ï¼Œé‚£ä¹ˆå¯ä»¥é…ç½® stopAfterFirstSuccess å±æ€§çš„å€¼ï¼Œé…ç½®æ–¹å¼å¦‚ä¸‹ï¼š

```xml
<bean class="org.apache.shiro.web.mgt.DefaultWebSecurityManager" id="securityManager">
  <property name="authenticator">
    <bean class="org.apache.shiro.authc.pam.ModularRealmAuthenticator">
      <property name="realms">
        <list>
          <!-- é¡ºåºå¾ˆå…³é”®ï¼Œè®¤è¯çš„æ—¶å€™ä¼šæŒ‰ç…§è¿™ä¸ªé¡ºåºå»è®¤è¯ -->
          <ref bean="myRealm01"/>
          <ref bean="myRealm02"/>
        </list>
      </property>
      <property name="authenticationStrategy">
        <!-- åªè¿”å›ç¬¬ä¸€ä¸ªè®¤è¯æˆåŠŸçš„ Realm ä¿¡æ¯ï¼›é»˜è®¤æƒ…å†µä¸‹ï¼Œå³ä½¿å·²ç»æœ‰ Realm è®¤è¯æˆåŠŸï¼Œå‰©ä¸‹çš„ Realm è¿˜ä¼šç»§ç»­è¿›è¡Œè®¤è¯æ“ä½œ -->
        <bean class="org.apache.shiro.authc.pam.FirstSuccessfulStrategy">
          <!-- å½“å·²ç»æœ‰ Realm è®¤è¯æˆåŠŸï¼Œå‰©ä¸‹çš„ Realm å°±ä¸ç”¨å†è¿›è¡Œè®¤è¯äº† -->
          <property name="stopAfterFirstSuccess" value="true"/>
        </bean>
      </property>
    </bean>
  </property>
</bean>
```

## 8 ä¸‰ç§ç™»å½•æ–¹å¼

### 8.1 è‡ªå®šä¹‰è¡¨å•ç™»å½•

applicationContext.xml ä¿®æ”¹ authenticator çš„é…ç½®

```xml
<bean class="org.apache.shiro.web.mgt.DefaultWebSecurityManager" id="securityManager">
  <property name="authenticator">
    <bean class="org.apache.shiro.authc.pam.ModularRealmAuthenticator">
      <property name="realms">
        <list>
          <ref bean="myRealm02"/>
        </list>
      </property>
      <property name="authenticationStrategy">
        <!-- è‡³å°‘æœ‰ä¸€ä¸ª Realm è®¤è¯æˆåŠŸæ‰ç®—æˆåŠŸï¼Œå¦‚æœæœ‰å¤šä¸ª Realm è®¤è¯æˆåŠŸï¼Œé‚£ä¹ˆä¼šè¿”å›æ‰€æœ‰è®¤è¯æˆåŠŸ Realm çš„ä¿¡æ¯ -->
        <bean class="org.apache.shiro.authc.pam.AtLeastOneSuccessfulStrategy"/>
      </property>
    </bean>
  </property>
</bean>
```

ç™»å½•è¡¨å•

```jsp
<%--
  Created by IntelliJ IDEA.
  User: yue
  Date: 2023/3/7
  Time: 21:44
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>ç™»å½•</title>
</head>
<body>
<div>
    <div style="color: red">${errorMsg1}</div>
    <div style="color: red">${errorMsg2}</div>

    <form action="login" method="post">
        <table>
            <tr>
                <td>ç™»å½•ç”¨æˆ·ï¼š</td>
                <td><input type="text" name="username"></td>
            </tr>
            <tr>
                <td>ç™»å½•å¯†ç ï¼š</td>
                <td><input type="password" name="password"></td>
            </tr>
            <tr>
                <td><input type="submit" value="ç™»å½•"></td>
            </tr>
        </table>
    </form>
</div>
</body>
</html>
```

é¦–é¡µ

```jsp
<%--
  Created by IntelliJ IDEA.
  User: yue
  Date: 2023/3/7
  Time: 21:45
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>é¦–é¡µ</title>
</head>
<body>
<div>
    ç™»å½•æˆåŠŸ
</div>
</body>
</html>

```

ä¿®æ”¹ç™»å½•æ¥å£ LoginController.java

```java
/**
 * @Author yueyazhui
 * @Date 2023/2/18
 */
@Controller
public class LoginController {

    @PostMapping(value = "login", produces = "text/html;charset=utf-8")
    public String login(String username, String password, Model model) {
        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest();
        UsernamePasswordToken usernamePasswordToken = new UsernamePasswordToken(username, password);
        try {
            // æ‰§è¡Œç™»å½•
            Subject subject = SecurityUtils.getSubject();
            subject.login(usernamePasswordToken);
            List list = subject.getPrincipals().asList();
            for (Object o : list) {
                System.out.println("o = " + o);
            }
        } catch (AuthenticationException e) {
            request.setAttribute("errorMsg1", e.getMessage());
            model.addAttribute("errorMsg2", e.getMessage());
            return "forward:/loginForm";
        }
        // ç™»å½•æˆåŠŸï¼Œé‡å®šå‘åˆ° index
        return "redirect:/index";
    }

    @RequestMapping("index")
    public String index() {
        return "index";
    }

    @RequestMapping("loginForm")
    public String loginForm() {
        return "loginForm";
    }
}
```

applicationContext.xml ä¿®æ”¹ shiroFilter çš„å±æ€§é…ç½®ï¼Œé…ç½®ç™»å½•é¡µé¢

```xml
<bean class="org.apache.shiro.spring.web.ShiroFilterFactoryBean" id="shiroFilter">
  <property name="securityManager" ref="securityManager"/>
  <!-- é…ç½®ç™»å½•é¡µé¢ -->
  <property name="loginUrl" value="/loginForm"/>
  <property name="filterChainDefinitions">
    <!--
     /login åŒ¿åè®¿é—®
     /** å‰©ä½™çš„å…¶ä»–æ¥å£ï¼Œéœ€è¦è®¤è¯æ‰èƒ½è®¿é—®
     -->
    <value>
      /login=anon
      /**=authc
    </value>
  </property>
</bean>
```

æµ‹è¯•ï¼š

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303080010622.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303080012866.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303080012004.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303080015559.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303080021118.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303080023944.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303080023181.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303092142921.png)

### 8.2 é»˜è®¤è¡¨å•ç™»å½•

```java
/**
 * Shiro æä¾›çš„è¡¨å•ç™»å½•ï¼Œè¿™ä¸ªæ¥å£æä¾›äº†ä¸¤ä¸ªåŠŸèƒ½
 * 1ã€æä¾›ç™»å½•é¡µé¢
 * 2ã€å¤„ç†ç™»å½•è¯·æ±‚
 * @param model
 * @return
 */
@RequestMapping(value = "login", produces = "text/html;charset=utf-8")
public String login(Model model) {
  HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest();
  // è·å–ç™»å½•å¤±è´¥çš„å¼‚å¸¸ä¿¡æ¯
  String shiroLoginFailure = (String) request.getAttribute("shiroLoginFailure");
  if(UnknownAccountException.class.getName().equals(shiroLoginFailure) || IncorrectCredentialsException.class.getName().equals(shiroLoginFailure)) {
    request.setAttribute("errorMsg1", "ç”¨æˆ·åæˆ–å¯†ç è¾“å…¥é”™è¯¯");
    model.addAttribute("errorMsg2", "ç”¨æˆ·åæˆ–å¯†ç è¾“å…¥é”™è¯¯");
  }
  return "loginForm";
}
```

ä¿®æ”¹ applicationContext.xml ä¸­ shiroFilter çš„é…ç½®

```xml
<bean class="org.apache.shiro.spring.web.ShiroFilterFactoryBean" id="shiroFilter">
  <property name="securityManager" ref="securityManager"/>
  <!-- é…ç½®ç™»å½•é¡µé¢ -->
  <property name="loginUrl" value="/login"/>
  <!-- ç™»å½•æˆåŠŸè·³è½¬çš„åœ°å€ -->
  <property name="successUrl" value="/index"/>
  <!-- æƒé™ä¸è¶³è·³è½¬çš„åœ°å€ -->
  <property name="unauthorizedUrl" value="/unauthorized"/>
  <property name="filterChainDefinitions">
    <value>
      /**=authc
    </value>
  </property>
</bean>
```

æµ‹è¯•ï¼š

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303082230530.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303082236535.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303082236535.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303082237010.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303082238704.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303092142921.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303082239752.png)

### 8.3 HTTP Basic ç™»å½•

ä¸å®‰å…¨

æ— æ³•æ³¨é”€

åœ¨ applicationContext.xml ä¸­ä¿®æ”¹ shiroFilter é…ç½®

```xml
<bean class="org.apache.shiro.spring.web.ShiroFilterFactoryBean" id="shiroFilter">
  <property name="securityManager" ref="securityManager"/>
  <!-- é…ç½®ç™»å½•é¡µé¢ -->
  <property name="loginUrl" value="/login"/>
  <!-- ç™»å½•æˆåŠŸè·³è½¬çš„åœ°å€ -->
  <property name="successUrl" value="/index"/>
  <!-- æƒé™ä¸è¶³è·³è½¬çš„åœ°å€ -->
  <property name="unauthorizedUrl" value="/unauthorized"/>
  <property name="filterChainDefinitions">
    <value>
      /**=authcBasic
    </value>
  </property>
</bean>
```

æµ‹è¯•

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303092134537.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303092136470.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303092141122.png)

SpringSecurity åœ¨ HTTP Basic ç™»å½•æ—¶ï¼Œæä¾›äº† MD5 åŠ å¯†ï¼Œç›¸å¯¹æ¥è¯´æ›´å®‰å…¨

### 8.4 æ³¨é”€ç™»å½•

* è¿”å›è¡¨å•

  åœ¨ applicationContext.xml ä¸­ä¿®æ”¹ shiroFilter é…ç½®

  ```xml
  <bean class="org.apache.shiro.spring.web.ShiroFilterFactoryBean" id="shiroFilter">
    <property name="securityManager" ref="securityManager"/>
    <!-- é…ç½®ç™»å½•é¡µé¢ -->
    <property name="loginUrl" value="/login"/>
    <!-- ç™»å½•æˆåŠŸè·³è½¬çš„åœ°å€ -->
    <property name="successUrl" value="/index"/>
    <!-- æƒé™ä¸è¶³è·³è½¬çš„åœ°å€ -->
    <property name="unauthorizedUrl" value="/unauthorized"/>
    <property name="filterChainDefinitions">
      <value>
        /logout=logout
        /**=authc
      </value>
    </property>
  </bean>
  ```

  æµ‹è¯•

  ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303092158077.png)

  ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303092159597.png)

* è¿”å› JSON

åœ¨ applicationContext.xml ä¸­ä¿®æ”¹ shiroFilter é…ç½®

```xml
<bean class="org.apache.shiro.spring.web.ShiroFilterFactoryBean" id="shiroFilter">
  <property name="securityManager" ref="securityManager"/>
  <!-- é…ç½®ç™»å½•é¡µé¢ -->
  <property name="loginUrl" value="/login"/>
  <!-- ç™»å½•æˆåŠŸè·³è½¬çš„åœ°å€ -->
  <property name="successUrl" value="/index"/>
  <!-- æƒé™ä¸è¶³è·³è½¬çš„åœ°å€ -->
  <property name="unauthorizedUrl" value="/unauthorized"/>
  <property name="filterChainDefinitions">
    <value>
      /**=authc
    </value>
  </property>
</bean>
```

LoginController.java

```java
@GetMapping("logout")
@ResponseBody
public Response logout() {
  try {
    SecurityUtils.getSubject().logout();
    return Response.success("æ³¨é”€æˆåŠŸ");
  } catch (Exception e) {
    return Response.error("æ³¨é”€å¤±è´¥");
  }
}
```

æµ‹è¯•

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303092216900.png)

### 8.5 RememberMe

æ²¡æœ‰å¼€å¯ RememberMe çš„æµ‹è¯•

ç™»å½•ï¼š

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303102140877.png)

å…³é—­æµè§ˆå™¨

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303102143711.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303102144003.png)

ä¿®æ”¹ç™»å½•æ¥å£

```java
@GetMapping(value = "login", produces = "text/html;charset=utf-8")
public String login() {
  return "loginForm";
}

@PostMapping(value = "login", produces = "text/html;charset=utf-8")
public String login(String username, String password, Model model) {
  HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest();
  UsernamePasswordToken usernamePasswordToken = new UsernamePasswordToken(username, password);
  // å¼€å¯ RememberMe
  usernamePasswordToken.setRememberMe(true);
  try {
    // æ‰§è¡Œç™»å½•
    Subject subject = SecurityUtils.getSubject();
    subject.login(usernamePasswordToken);
    List list = subject.getPrincipals().asList();
    for (Object o : list) {
      System.out.println("o = " + o);
    }
  } catch (AuthenticationException e) {
    request.setAttribute("errorMsg1", e.getMessage());
    model.addAttribute("errorMsg2", e.getMessage());
    return "forward:/loginForm";
  }
  // ç™»å½•æˆåŠŸï¼Œé‡å®šå‘åˆ° index
  return "redirect:/index";
}
```

åœ¨ applicationContext.xml ä¸­ä¿®æ”¹ shiroFilter çš„é…ç½®ï¼š/hello å…è®¸ RememberMe ç™»å½•

```xml
<bean class="org.apache.shiro.spring.web.ShiroFilterFactoryBean" id="shiroFilter">
  <property name="securityManager" ref="securityManager"/>
  <!-- é…ç½®ç™»å½•é¡µé¢ -->
  <property name="loginUrl" value="/login"/>
  <!-- ç™»å½•æˆåŠŸè·³è½¬çš„åœ°å€ -->
  <property name="successUrl" value="/index"/>
  <!-- æƒé™ä¸è¶³è·³è½¬çš„åœ°å€ -->
  <property name="unauthorizedUrl" value="/unauthorized"/>
  <property name="filterChainDefinitions">
    <value>
      /login=anon
      /hello=user
      /**=authc
    </value>
  </property>
</bean>
```

æµ‹è¯•

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303102212787.png)

é€€å‡ºæµè§ˆå™¨

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303102212787.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303102216623.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303102217193.png)

RememberMe åˆæ­¥åˆ†æ

Shiro åœ¨ç™»å½•æ—¶ï¼Œåœ°å€æ ä¸­ä¼šæŠŠ jssessionid æ˜¾ç¤ºå‡ºæ¥ï¼Œä¼šå­˜åœ¨å®‰å…¨æ€§é—®é¢˜ã€‚

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303102305709.png)

æ›´æ¢ Shiro ç‰ˆæœ¬ V1.7.1 â€”> V1.11.0

ç™»å½•æˆåŠŸåï¼Œåœ¨å“åº”å¤´çš„ Set-Cookie ä¸­åŒ…å« rememberMe

Path=/shiroï¼šurl åŸºç¡€è·¯å¾„

Max-Age=31536000ï¼šå¤šä¹…è¿‡æœŸï¼Œé»˜è®¤ä¸€å¹´

Expires=Sat, 09-Mar-2024 15:13:30 GMTï¼šåˆ°æœŸæ—¶é—´

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303102318988.png)

ç™»å½•æˆåŠŸä¹‹åçš„è¯·æ±‚ï¼Œåœ¨è¯·æ±‚å¤´ä¸­ä¼šæºå¸¦ Cookie

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303102327008.png)

RememberMe æºç è¿½è¸ª

1. è·å–èº«ä»½ä¿¡æ¯
2. å°†èº«ä»½ä¿¡æ¯åºåˆ—åŒ–è½¬æˆå­—èŠ‚æ•°ç»„
3. è·å–åŠ å¯†å·¥å…·ï¼Œé»˜è®¤ AES å¯¹ç§°åŠ å¯†
4. Base64 è½¬ç 
5. èµ‹å€¼ç»™æ¨¡ç‰ˆ Cookie

é…ç½® å¤šä¹…è¿‡æœŸ maxAge

åœ¨ applicationContext.xml ä¸­ä¿®æ”¹ securityManager çš„é…ç½®

```xml
<bean class="org.apache.shiro.web.mgt.DefaultWebSecurityManager" id="securityManager">
  <property name="rememberMeManager">
    <bean class="org.apache.shiro.web.mgt.CookieRememberMeManager">
      <property name="cookie">
        <bean class="org.apache.shiro.web.servlet.SimpleCookie">
          <property name="name" value="rememberMe"/>
          <!-- å¤šä¹…è¿‡æœŸï¼šä¸€å‘¨ -->
          <property name="maxAge" value="604800"/>
        </bean>
      </property>
    </bean>
  </property>
  <property name="authenticator">
    <bean class="org.apache.shiro.authc.pam.ModularRealmAuthenticator">
      <property name="realms">
        <list>
          <!-- é¡ºåºå¾ˆå…³é”®ï¼Œè®¤è¯çš„æ—¶å€™ä¼šæŒ‰ç…§è¿™ä¸ªé¡ºåºå»è®¤è¯ -->
          <!--                        <ref bean="myRealm01"/>-->
          <ref bean="myRealm02"/>
        </list>
      </property>
      <property name="authenticationStrategy">
        <!-- è‡³å°‘æœ‰ä¸€ä¸ª Realm è®¤è¯æˆåŠŸæ‰ç®—æˆåŠŸï¼Œå¦‚æœæœ‰å¤šä¸ª Realm è®¤è¯æˆåŠŸï¼Œé‚£ä¹ˆä¼šè¿”å›æ‰€æœ‰è®¤è¯æˆåŠŸ Realm çš„ä¿¡æ¯ -->
        <bean class="org.apache.shiro.authc.pam.AtLeastOneSuccessfulStrategy"/>
      </property>
    </bean>
  </property>
</bean>
```

æµ‹è¯•

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303102352380.png)

## 9 æˆæƒ

æµ‹è¯•æ¥å£

```java
@RestController
public class HelloController {

    @GetMapping({"","hello"})
    public String hello() {
        return "Hello Shiro";
    }

    @GetMapping("admin")
    public String admin() {
        return "Hello Admin";
    }

    @GetMapping("unauthorized")
    public String unauthorized() {
        return "Hello Unauthorized";
    }
}
```

åœ¨ applicationContext.xml ä¸­ä¿®æ”¹ shiroFilter çš„é…ç½®

```xml
<bean class="org.apache.shiro.spring.web.ShiroFilterFactoryBean" id="shiroFilter">
  <property name="securityManager" ref="securityManager"/>
  <!-- é…ç½®ç™»å½•é¡µé¢ -->
  <property name="loginUrl" value="/login"/>
  <!-- ç™»å½•æˆåŠŸè·³è½¬çš„åœ°å€ -->
  <property name="successUrl" value="/index"/>
  <!-- æƒé™ä¸è¶³è·³è½¬çš„åœ°å€ -->
  <property name="unauthorizedUrl" value="/unauthorized"/>
  <property name="filterChainDefinitions">
    <value>
      /login=anon
      /hello=user
      /admin=roles[admin]
      /**=authc
    </value>
  </property>
</bean>
```

æµ‹è¯•

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303121812326.png)

æŠ¥é”™ä¿¡æ¯ï¼šæ²¡æœ‰é…ç½® Realmï¼Œè¿™æ˜¯å› ä¸ºé…ç½®çš„ Realm åªæœ‰è®¤è¯åŠŸèƒ½ï¼Œæ²¡æœ‰æˆæƒåŠŸèƒ½ã€‚

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303121825861.png)

ä¿®æ”¹ MyRealm02.java

```java
/**
 * @Author yueyazhui
 * @Date 2023/2/25
 *
 * ç»§æ‰¿ AuthenticatingRealm å¯ä»¥å®ç°è®¤è¯åŠŸèƒ½
 * ç»§æ‰¿ AuthorizingRealm å¯ä»¥å®ç°è®¤è¯ã€æˆæƒåŠŸèƒ½
 */
public class MyRealm02 extends AuthorizingRealm {

    private UserService userService;

    public MyRealm02(UserService userService) {
        this.userService = userService;
    }

    /**
     * æ ¸å¿ƒæ–¹æ³•ï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆè®¤è¯ï¼‰
     *
     * @param authenticationToken åŒ…å«ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ç­‰ä¿¡æ¯
     * @return ä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯
     * @throws AuthenticationException
     */
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
        UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) authenticationToken;
        // è·å–ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥çš„ç”¨æˆ·å
        String username = usernamePasswordToken.getUsername();
        User user = userService.getUserByUsername(username);
        if (ObjectUtil.isNull(user)) {
            throw new UnknownAccountException("ç”¨æˆ·åè¾“å…¥é”™è¯¯");
        }
        // è¿”å›æŸ¥è¯¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨æˆ·åã€å¯†ç ã€ç›ï¼‰
        return new SimpleAuthenticationInfo(user.getUsername(), user.getPassword(), getName());
    }

    /**
     * è¿”å›ç”¨æˆ·çš„è§’è‰²å’Œæƒé™ï¼ˆæˆæƒï¼‰
     * @param principalCollection å«æœ‰ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯
     * @return
     */
    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) {
        // è·å–ç™»å½•ç”¨æˆ·
        String username = (String) principalCollection.getPrimaryPrincipal();
        return new SimpleAuthorizationInfo(userService.findRolesByUsername(username));
    }
}
```

åœ¨ applicationContext.xml ä¸­ä¿®æ”¹ securityManager çš„é…ç½®ï¼Œæˆæƒæ—¶ realms ä¸èƒ½é…ç½®ç»™ ModularRealmAuthenticatorï¼Œè€Œè¦ç›´æ¥é…ç½®ç»™ securityManagerï¼Œå¹¶ä¸”è¦é…ç½®åˆ° authenticator çš„åé¢ï¼Œå› ä¸º setRealms æ—¶ ä¼šè°ƒç”¨ authenticator

```xml
<bean class="org.apache.shiro.web.mgt.DefaultWebSecurityManager" id="securityManager">
  <property name="rememberMeManager">
    <bean class="org.apache.shiro.web.mgt.CookieRememberMeManager">
      <property name="cookie">
        <bean class="org.apache.shiro.web.servlet.SimpleCookie">
          <property name="name" value="rememberMe"/>
          <!-- å¤šä¹…è¿‡æœŸï¼šä¸€å‘¨ -->
          <property name="maxAge" value="604800"/>
        </bean>
      </property>
    </bean>
  </property>
  <property name="authenticator">
    <bean class="org.apache.shiro.authc.pam.ModularRealmAuthenticator">
      <!--                <property name="realms">-->
      <!--                    <list>-->
      <!--                        <ref bean="myRealm02"/>-->
      <!--                    </list>-->
      <!--                </property>-->
      <property name="authenticationStrategy">
        <!-- è‡³å°‘æœ‰ä¸€ä¸ª Realm è®¤è¯æˆåŠŸæ‰ç®—æˆåŠŸï¼Œå¦‚æœæœ‰å¤šä¸ª Realm è®¤è¯æˆåŠŸï¼Œé‚£ä¹ˆä¼šè¿”å›æ‰€æœ‰è®¤è¯æˆåŠŸ Realm çš„ä¿¡æ¯ -->
        <bean class="org.apache.shiro.authc.pam.AtLeastOneSuccessfulStrategy"/>
      </property>
    </bean>
  </property>
  <property name="realms">
    <list>
      <bean class="top.yueyazhui.learn_shiro.realm.MyRealm02"/>
    </list>
  </property>
</bean>
```

æµ‹è¯•

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303122053580.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303122054855.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303122054135.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303122055718.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303122056549.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303122057723.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303122054855.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303122054135.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303122102521.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303122103800.png)

æ³¨è§£

ä¿®æ”¹ applicationContext.xml é…ç½®

```xml
<bean class="org.apache.shiro.spring.web.ShiroFilterFactoryBean" id="shiroFilter">
  <property name="securityManager" ref="securityManager"/>
  <!-- é…ç½®ç™»å½•é¡µé¢ -->
  <property name="loginUrl" value="/login"/>
  <!-- ç™»å½•æˆåŠŸè·³è½¬çš„åœ°å€ -->
  <property name="successUrl" value="/index"/>
  <!-- æƒé™ä¸è¶³è·³è½¬çš„åœ°å€ -->
  <property name="unauthorizedUrl" value="/unauthorized"/>
  <property name="filterChainDefinitions">
    <value>
      /login=anon
      /hello=user
      /**=authc
    </value>
  </property>
</bean>

<!-- æ”¯æŒåŸºäºæ³¨è§£çš„æƒé™é…ç½® -->
<bean class="org.apache.shiro.spring.LifecycleBeanPostProcessor" id="beanPostProcessor"/>
<bean class="org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"/>
<bean class="org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor">
  <property name="securityManager" ref="securityManager"/>
</bean>
```

HelloController.java

```java
@RestController
public class HelloController {

    @Autowired
    HelloService helloService;

    @GetMapping({"","hello"})
    public String hello() {
        return helloService.hello();
    }

    @GetMapping("admin")
    public String admin() {
        return helloService.admin();
    }
}
```

HelloServiceImpl.java

```java
@Service
public class HelloServiceImpl implements HelloService {

    @Override
    @RequiresUser // ç™»å½•ä¹‹åå°±å¯ä»¥è®¿é—®ï¼›æ— è®ºæ˜¯ Realm è®¤è¯ç™»å½•ï¼Œè¿˜æ˜¯ RememberMe è®¤è¯ç™»å½•
//    @RequiresAuthentication // Realm è®¤è¯ç™»å½•å¯ä»¥è®¿é—®ï¼ŒRememberMe è®¤è¯ç™»å½•ä¸èƒ½è®¿é—®
    public String hello() {
        return "Hello Shiro";
    }

    @Override
    @RequiresRoles("admin")
    public String admin() {
        return "Hello Admin";
    }
}
```

æµ‹è¯•

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303160009508.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303160010429.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303160010099.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303160011001.png)

![](https://yueyazhui.top/assets/image/screenshot/202303160011363.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303160012361.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303160013965.png)

JSP æ ‡ç­¾

```jsp
<%@ taglib prefix="shiro" uri="http://shiro.apache.org/tags" %>
<%--
  Created by IntelliJ IDEA.
  User: yue
  Date: 2023/3/19
  Time: 14:53
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>JSP</title>
</head>
<body>
ã€guestã€‘
<shiro:guest>
    guestï¼šæ¸¸å®¢å¯ä»¥è®¿é—®
</shiro:guest>
<hr>
ã€userã€‘
<shiro:user>
    userï¼šç™»å½•å¯ä»¥è®¿é—®ï¼Œä¸ç®¡æ˜¯é€šè¿‡ç”¨æˆ·å/å¯†ç ç™»å½•è¿˜æ˜¯é€šè¿‡ RememberMe ç™»å½•<br>
    ç”¨æˆ·åï¼š<shiro:principal/><br>
    <a href="/shiro/hello">Hello</a>
</shiro:user>
<hr>
ã€authenticatedã€‘
<shiro:authenticated>
    authenticatedï¼šé€šè¿‡ç”¨æˆ·å/å¯†ç ç™»å½•å¯ä»¥è®¿é—®
</shiro:authenticated>
<hr>
ã€notAuthenticatedã€‘
<shiro:notAuthenticated>
    notAuthenticatedï¼šæ²¡æœ‰é€šè¿‡ç”¨æˆ·å/å¯†ç ç™»å½•å¯ä»¥è®¿é—®
</shiro:notAuthenticated>
<hr>
ã€hasRole-adminã€‘
<shiro:hasRole name="admin">
    hasRole-adminï¼šç”¨æˆ·æœ‰ admin çš„è§’è‰²å¯ä»¥è®¿é—®<br>
    <a href="/shiro/admin">Admin</a>
</shiro:hasRole>
<hr>
ã€lacksRole-adminã€‘
<shiro:lacksRole name="admin">
    lacksRole-adminï¼šç”¨æˆ·æ²¡æœ‰ admin çš„è§’è‰²å¯ä»¥è®¿é—®
</shiro:lacksRole>
</body>
</html>
```

```java
@Controller
public class JspController {

    @GetMapping("jsp")
    public String jsp() {
        return "jsp";
    }
}
```

ä¿®æ”¹ applicationContext.xml é…ç½®

```xml
<bean class="org.apache.shiro.spring.web.ShiroFilterFactoryBean" id="shiroFilter">
  <property name="securityManager" ref="securityManager"/>
  <!-- é…ç½®ç™»å½•é¡µé¢ -->
  <property name="loginUrl" value="/login"/>
  <!-- ç™»å½•æˆåŠŸè·³è½¬çš„åœ°å€ -->
  <property name="successUrl" value="/index"/>
  <!-- æƒé™ä¸è¶³è·³è½¬çš„åœ°å€ -->
  <property name="unauthorizedUrl" value="/unauthorized"/>
  <property name="filterChainDefinitions">
    <value>
      /jsp=anon
      /login=anon
      /hello=user
      /logout=logout
      /**=authc
    </value>
  </property>
</bean>
```

æµ‹è¯•ï¼š

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303191539254.png)

![](https://yueyazhui.top/assets/image/screenshot/202303191540409.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303191543784.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303191543901.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303191545880.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303191546868.png)

é‡å¯æµè§ˆå™¨

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303191551448.png)

ç¼“å­˜æœºåˆ¶

æ·»åŠ ä¾èµ–ï¼š

```xml
<dependency>
  <groupId>org.apache.shiro</groupId>
  <artifactId>shiro-ehcache</artifactId>
  <version>${shiro.version}</version>
</dependency>
```

ehcache.xml

å¤åˆ¶å®˜æ–¹æ¨¡ç‰ˆ

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303191610030.png)

```xml
<!-- é…ç½®ç¼“å­˜ç­–ç•¥ -->
<ehcache>
    <diskStore path="java.io.tmpdir/shiro-spring-sample"/>

    <defaultCache
            maxElementsInMemory="10000"
            eternal="false"
            timeToIdleSeconds="120"
            timeToLiveSeconds="120"
            overflowToDisk="false"
            diskPersistent="false"
            diskExpiryThreadIntervalSeconds="120"/>

    <cache name="shiro-activeSessionCache"
           maxElementsInMemory="10000"
           eternal="true"
           overflowToDisk="true"
           diskPersistent="true"
           diskExpiryThreadIntervalSeconds="600"/>

    <cache name="org.apache.shiro.realm.SimpleAccountRealm.authorization"
           maxElementsInMemory="100"
           eternal="false"
           timeToLiveSeconds="600"
           overflowToDisk="false"/>
</ehcache>
```

åœ¨ applicationContext.xml ä¸­é…ç½®ç¼“å­˜

```xml
<bean class="org.apache.shiro.cache.ehcache.EhCacheManager" id="ehCacheManager">
  <property name="cacheManagerConfigFile" value="classpath:ehcache.xml"/>
</bean>

<bean class="org.apache.shiro.web.mgt.DefaultWebSecurityManager" id="securityManager">
  <property name="cacheManager" ref="ehCacheManager"/>
  <property name="rememberMeManager">
    <bean class="org.apache.shiro.web.mgt.CookieRememberMeManager">
      <property name="cookie">
        <bean class="org.apache.shiro.web.servlet.SimpleCookie">
          <property name="name" value="rememberMe"/>
          <!-- å¤šä¹…è¿‡æœŸï¼šä¸€å‘¨ -->
          <property name="maxAge" value="604800"/>
        </bean>
      </property>
    </bean>
  </property>
  <property name="authenticator">
    <bean class="org.apache.shiro.authc.pam.ModularRealmAuthenticator">
      <property name="authenticationStrategy">
        <!-- è‡³å°‘æœ‰ä¸€ä¸ª Realm è®¤è¯æˆåŠŸæ‰ç®—æˆåŠŸï¼Œå¦‚æœæœ‰å¤šä¸ª Realm è®¤è¯æˆåŠŸï¼Œé‚£ä¹ˆä¼šè¿”å›æ‰€æœ‰è®¤è¯æˆåŠŸ Realm çš„ä¿¡æ¯ -->
        <bean class="org.apache.shiro.authc.pam.AtLeastOneSuccessfulStrategy"/>
      </property>
    </bean>
  </property>
  <property name="realms">
    <list>
      <bean class="top.yueyazhui.learn_shiro.realm.MyRealm02"/>
    </list>
  </property>
</bean>

<bean class="org.apache.shiro.spring.web.ShiroFilterFactoryBean" id="shiroFilter">
  <property name="securityManager" ref="securityManager"/>
  <!-- é…ç½®ç™»å½•é¡µé¢ -->
  <property name="loginUrl" value="/login"/>
  <!-- ç™»å½•æˆåŠŸè·³è½¬çš„åœ°å€ -->
  <property name="successUrl" value="/index"/>
  <!-- æƒé™ä¸è¶³è·³è½¬çš„åœ°å€ -->
  <property name="unauthorizedUrl" value="/unauthorized"/>
  <property name="filterChainDefinitions">
    <value>
      /jsp=anon
      /login=anon
      /hello=user
      /admin=roles[admin]
      /logout=logout
      /**=authc
    </value>
  </property>
</bean>
```

æµ‹è¯•

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303191717797.png)

![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303191711709.png)

## 10 SpringBoot é›†æˆ Shiro

åœ¨ SpringBoot ä¸­ï¼Œå»ºè®®ä½¿ç”¨ SpringSecurity

### 10.1 åŸºç¡€æ­å»º

1. åˆ›å»º SpringBoot é¡¹ç›®ï¼Œæ·»åŠ  `Spring Web`ã€`MySQL Driver` å’Œ `MyBatis Framework` ä¾èµ–![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303212320122.png)

   ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303212322140.png)

2. æ·»åŠ  `Shiro` ä¾èµ–

   ```xml
   <dependency>
     <groupId>org.apache.shiro</groupId>
     <artifactId>shiro-spring-boot-web-starter</artifactId>
     <version>1.11.0</version>
   </dependency>
   ```

3. é…ç½®åœ¨ maven ç¼–è¯‘æ—¶ä¸è¦è¿‡æ»¤æ‰ java åŒ…å†…çš„ xml æ–‡ä»¶

   ```xml
   <build>
     <resources>
       <resource>
         <directory>src/main/java</directory>
         <includes>
           <include>**/*.xml</include>
         </includes>
       </resource>
       <resource>
         <directory>src/main/resources</directory>
       </resource>
     </resources>
     ...
   </build>
   ```

4. åœ¨ application.properties æ–‡ä»¶ä¸­ï¼Œé…ç½®æ•°æ®åº“ã€Mybatis å’Œ Shiro

   ```properties
   # åº”ç”¨åç§°
   spring.application.name=learn_shiro_spring_boot
   # åº”ç”¨æœåŠ¡ WEB è®¿é—®ç«¯å£
   server.port=8080

   # æ•°æ®åº“é©±åŠ¨
   spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
   # æ•°æ®æºåç§°
   spring.datasource.name=defaultDataSource
   # æ•°æ®åº“è¿æ¥åœ°å€
   spring.datasource.url=jdbc:mysql:///learn_shiro?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=Asia/Shanghai&allowMultiQueries=true
   # æ•°æ®åº“ç”¨æˆ·å
   spring.datasource.username=root
   # æ•°æ®åº“å¯†ç 
   spring.datasource.password=123456

   # æŒ‡å®š Mybatis çš„ Mapper ç›®å½•
   mybatis.mapper-locations=top/yueyazhui/learn_shiro_spring_boot/mapper/xml/*.xml
   # æŒ‡å®š Mybatis çš„å®ä½“ç›®å½•
   mybatis.type-aliases-package=top.yueyazhui.learn_shiro_spring_boot.entity

   # å¼€å¯ Shiroï¼Œé»˜è®¤ true
   shiro.enabled=true
   # å¼€å¯ Shiro Web çš„è‡ªåŠ¨åŒ–é…ç½®ï¼Œé»˜è®¤ true
   shiro.web.enabled=true
   # é…ç½®ç™»å½•åœ°å€
   shiro.loginUrl=/login
   # sessionId å­˜å…¥ cookie
   shiro.sessionManager.sessionIdCookieEnabled=true
   # sessionId å­˜æ”¾åœ°å€æ 
   shiro.sessionManager.sessionIdUrlRewritingEnabled=false
   ```

5. ç›®å½•ç»“æ„

   ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303212357835.png)

6. ShiroConfig.java

   ```java
   @Configuration
   public class ShiroConfig {

       @Autowired
       MyRealm02 myRealm02;

       @Bean
       DefaultWebSecurityManager defaultWebSecurityManager () {
           DefaultWebSecurityManager defaultWebSecurityManager = new DefaultWebSecurityManager();
           defaultWebSecurityManager.setRealm(myRealm02);
           return defaultWebSecurityManager;
       }

       @Bean
       ShiroFilterChainDefinition shiroFilterChainDefinition () {
           DefaultShiroFilterChainDefinition shiroFilterChainDefinition = new DefaultShiroFilterChainDefinition();
           shiroFilterChainDefinition.addPathDefinition("/login", "anon");
           shiroFilterChainDefinition.addPathDefinition("/logout", "logout");
           shiroFilterChainDefinition.addPathDefinition("/**", "authc");
           return shiroFilterChainDefinition;
       }
   }
   ```

7. å…¶ä»–çš„æ–‡ä»¶éƒ½æ˜¯ä» SSM æ•´åˆ Shiro çš„é¡¹ç›®ä¸­ CV è¿‡æ¥çš„ã€‚åœ¨ SSM æ•´åˆ Shiro çš„é¡¹ç›®ä¸­ï¼ŒMyRealm02 æ˜¯æ²¡æœ‰æ³¨å†Œåˆ° Spring å®¹å™¨çš„ï¼Œåœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿å¼•ç”¨ï¼Œå°±æŠŠ MyRealm02 æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­äº†ã€‚åç»­è¿™ä¸ªé¡¹ç›®ä¼šå¢åŠ å¤šç§ç™»å½•æ–¹å¼ï¼ˆæ‰‹æœºéªŒè¯ç /QQ/å¾®ä¿¡ç­‰ï¼‰ï¼Œé¡¹ç›®ä¹Ÿä¼šä»¥å‰åç«¯åˆ†ç¦»çš„æ–¹å¼å»åšï¼Œå› æ­¤åœ¨è¿™é‡Œå°±ä¸é…ç½®ç™»å½•æˆåŠŸè·³è½¬åœ°å€/æƒé™ä¸è¶³è·³è½¬åœ°å€äº†ã€‚

   MyRealm02.java

   ```java
   /**
    * @Author yueyazhui
    * @Date 2023/2/25
    *
    * ç»§æ‰¿ AuthenticatingRealm å¯ä»¥å®ç°è®¤è¯åŠŸèƒ½
    * ç»§æ‰¿ AuthorizingRealm å¯ä»¥å®ç°è®¤è¯ã€æˆæƒåŠŸèƒ½
    */
   @Component
   public class MyRealm02 extends AuthorizingRealm {

       @Autowired
       UserService userService;

       /**
        * æ ¸å¿ƒæ–¹æ³•ï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆè®¤è¯ï¼‰
        *
        * @param authenticationToken åŒ…å«ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ç­‰ä¿¡æ¯
        * @return ä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯
        * @throws AuthenticationException
        */
       @Override
       protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
           UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) authenticationToken;
           // è·å–ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥çš„ç”¨æˆ·å
           String username = usernamePasswordToken.getUsername();
           User user = userService.getUserByUsername(username);
           if (ObjectUtil.isNull(user)) {
               throw new UnknownAccountException("ç”¨æˆ·åè¾“å…¥é”™è¯¯");
           }
           // è¿”å›æŸ¥è¯¢åˆ°çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨æˆ·åã€å¯†ç ã€ç›ï¼‰
           return new SimpleAuthenticationInfo(user.getUsername(), user.getPassword(), getName());
       }

       /**
        * è¿”å›ç”¨æˆ·çš„è§’è‰²å’Œæƒé™ï¼ˆæˆæƒï¼‰
        * @param principalCollection å«æœ‰ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯
        * @return
        */
       @Override
       protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) {
           // è·å–ç™»å½•ç”¨æˆ·
           String username = (String) principalCollection.getPrimaryPrincipal();
           return new SimpleAuthorizationInfo(userService.findRolesByUsername(username));
       }
   }
   ```

   LoginController.java

   ```java
   @RestController
   public class LoginController {

       @PostMapping("login")
       public Response login(String username, String password) {
           UsernamePasswordToken usernamePasswordToken = new UsernamePasswordToken(username, password);
           // å¼€å¯ RememberMe
           usernamePasswordToken.setRememberMe(true);
           try {
               // æ‰§è¡Œç™»å½•
               Subject subject = SecurityUtils.getSubject();
               subject.login(usernamePasswordToken);
               List list = subject.getPrincipals().asList();
               for (Object o : list) {
                   System.out.println("o = " + o);
               }
           } catch (AuthenticationException e) {
               return Response.error("ç™»å½•å¤±è´¥", e.getMessage());
           }
           return Response.success("ç™»å½•æˆåŠŸ");
       }

       @GetMapping("logout")
       public Response logout() {
           try {
               SecurityUtils.getSubject().logout();
               return Response.success("æ³¨é”€æˆåŠŸ");
           } catch (Exception e) {
               return Response.error("æ³¨é”€å¤±è´¥");
           }
       }
   }
   ```

   HelloController.java

   ```java
   @RestController
   public class HelloController {

       @GetMapping("hello")
       public String hello() {
           return "Hello";
       }

       @GetMapping("admin")
       @RequiresRoles("admin")
       public String admin() {
           return "Hello Admin";
       }
   }
   ```

8. æµ‹è¯•

   ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303220023396.png)

   ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303220024035.png)

   ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303220025201.png)

   ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303220026900.png)

   ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303220027823.png)

   ![](https://yueyazhui.top/assets/image/screenshot/Shiro_202303220028715.png)



## æºç 

[SSM æ•´åˆ Shiro](https://gitee.com/yueyazhui/learn_shiro.git)

[SpringBoot æ•´åˆ Shiro](https://gitee.com/yueyazhui/learn_shiro_spring_boot.git)

